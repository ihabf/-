<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ’¬ Ø¯Ø±Ø¯Ø´Ø© Ù…Ø¤Ù‚ØªØ©</title>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
    import {
      getDatabase, ref, push, set, remove, onValue, onChildAdded,
      onDisconnect, get, update
    } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";

    // ğŸ”¹ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDzGM7Zy6JIrFJyDj7s5SjAd-l8rbCe9VE",
      authDomain: "kelta-gmae.firebaseapp.com",
      databaseURL: "https://kelta-gmae-default-rtdb.firebaseio.com",
      projectId: "kelta-gmae",
      storageBucket: "kelta-gmae.firebasestorage.app",
      messagingSenderId: "247464874751",
      appId: "1:247464874751:web:779a3120e6b422fdee72ca",
      measurementId: "G-6C8HGRKLHS"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // ğŸ”¹ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    const usersRef = ref(db, "users");
    const messagesRef = ref(db, "messages");
    const chatRef = ref(db, "chat");
    const typingRef = ref(db, "typing");
    const savedUsersRef = ref(db, "savedUsers");

    // ğŸ”¹ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø¯ÙŠØ± (ÙŠÙ…ÙƒÙ†Ùƒ ØªØºÙŠÙŠØ±Ù‡ Ù„Ø§Ø­Ù‚Ù‹Ø§)
    const ADMIN_NAME = "KeltA"; 

    // ğŸ”¹ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù…
    const username = prompt("KeltA:")?.trim() || "KeltA";

    // ğŸ”¸ Ù…Ù†Ø¹ ØªÙƒØ±Ø§Ø± Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¯Ø§Ø®Ù„ Ø§Ù„ØºØ±ÙØ©
    const usersSnap = await get(usersRef);
    const usersData = usersSnap.val() || {};
    const existingUser = Object.values(usersData).find(u => u.name === username);
    if (existingUser) {
      alert("âŒ Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù… Ø­Ø§Ù„ÙŠØ§Ù‹! Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ø³Ù… Ø¢Ø®Ø±.");
      location.reload();
      throw new Error("Ø§Ø³Ù… Ù…ÙƒØ±Ø±");
    }

    const userId = "user_" + Math.floor(Math.random() * 100000);
    const colors = ["#ffadad","#ffd6a5","#fdffb6","#caffbf","#9bf6ff","#a0c4ff","#bdb2ff","#ffc6ff"];
    let userColor = colors[Math.floor(Math.random() * colors.length)];

    // ğŸ”¸ ÙØ­Øµ Ø¥Ù† ÙƒØ§Ù† Ø§Ù„Ø§Ø³Ù… Ù…Ø­ÙÙˆØ¸ Ù…Ø³Ø¨Ù‚Ù‹Ø§ (Ù„ÙˆÙ† Ù…Ø®ØµØµ)
    const savedSnap = await get(savedUsersRef);
    const savedData = savedSnap.val() || {};
    if (savedData[username]) {
      userColor = savedData[username].color;
      console.log(`ğŸ¨ ØªÙ… Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ù‚Ø¯ÙŠÙ… Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… ${username}`);
    } else {
      await set(ref(db, "savedUsers/" + username), { color: userColor });
    }

    // ğŸ”¹ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    const userRef = ref(db, "users/" + userId);
    await set(userRef, {
      name: username,
      color: userColor,
      online: true,
      lastSeen: Date.now()
    });

    // ğŸ”¹ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© ÙƒÙ„ 5 Ø«ÙˆØ§Ù†Ù
    setInterval(() => {
      update(userRef, { online: true, lastSeen: Date.now() });
    }, 5000);

    // ğŸ”¹ Ø¹Ù†Ø¯ Ø§Ù„Ø®Ø±ÙˆØ¬
    onDisconnect(userRef).remove();

    // ğŸ”¹ ØªÙ†Ø¸ÙŠÙ ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙÙŠ Ø­Ø§Ù„ Ø§Ù„ØºØ±ÙØ© ÙØ§Ø±ØºØ©
    async function cleanupIfEmpty() {
      const snapshot = await get(usersRef);
      const users = snapshot.val() || {};
      const now = Date.now();
      const activeUsers = Object.values(users).filter(u => now - (u.lastSeen || 0) < 10000);

      if (activeUsers.length === 0) {
        console.log("ğŸš® Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† â€” ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...");
        const messagesSnap = await get(messagesRef);
        if (messagesSnap.exists()) {
          messagesSnap.forEach(child => remove(ref(db, "messages/" + child.key)));
          console.log("ğŸ§¹ ØªÙ… Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„");
        }
        await Promise.all([remove(chatRef), remove(typingRef), remove(usersRef)]);
        console.log("âœ… ØªÙ… ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
      }
    }
    setInterval(cleanupIfEmpty, 10000);

    // ğŸ”¹ Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
    onValue(usersRef, (snapshot) => {
      const users = snapshot.val() || {};
      const userList = document.getElementById("users");
      userList.innerHTML = "";
      Object.values(users).forEach(u => {
        const li = document.createElement("li");
        li.textContent = u.name;
        li.style.borderRight = `6px solid ${u.color}`;
        userList.appendChild(li);
      });
    });

    // ğŸ”¹ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
    const form = document.getElementById("chatForm");
    const msgInput = document.getElementById("msg");
    const chatBox = document.getElementById("chat");
    const typingBox = document.getElementById("typing");

    form.addEventListener("submit", e => {
      e.preventDefault();
      const text = msgInput.value.trim();
      if (!text) return;
      const msgRef = push(messagesRef);
      set(msgRef, {
        user: username,
        color: userColor,
        text,
        time: new Date().toLocaleTimeString()
      });
      msgInput.value = "";
      remove(ref(db, "typing/" + userId));
    });

    // ğŸ”¹ Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
    onChildAdded(messagesRef, snapshot => {
      const m = snapshot.val();
      const div = document.createElement("div");
      div.className = "message";
      div.innerHTML = `<strong style="color:${m.color}">${m.user}:</strong> ${m.text}`;
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
    });

    // ğŸ”¹ "ÙŠÙƒØªØ¨ Ø§Ù„Ø¢Ù†..."
    msgInput.addEventListener("input", () => {
      set(ref(db, "typing/" + userId), { name: username });
      clearTimeout(window.typingTimeout);
      window.typingTimeout = setTimeout(() => remove(ref(db, "typing/" + userId)), 2000);
    });

    onValue(typingRef, snapshot => {
      const typingUsers = snapshot.val() || {};
      const names = Object.values(typingUsers).map(u => u.name).filter(n => n !== username);
      typingBox.textContent = names.length
        ? `${names.join(" Ùˆ ")} ${names.length > 1 ? "ÙŠÙƒØªØ¨ÙˆÙ† Ø§Ù„Ø¢Ù†..." : "ÙŠÙƒØªØ¨ Ø§Ù„Ø¢Ù†..."}`
        : "";
    });

    // ğŸ§¹ Ø²Ø± Ø§Ù„Ø­Ø°Ù Ø§Ù„ÙŠØ¯ÙˆÙŠ (Ù„Ù„Ù…Ø¯ÙŠØ± ÙÙ‚Ø·)
    if (username === ADMIN_NAME) {
      const delBtn = document.createElement("button");
      delBtn.textContent = "ğŸ§¹ Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„";
      delBtn.style.background = "#ff595e";
      delBtn.style.color = "#fff";
      delBtn.style.fontWeight = "bold";
      delBtn.style.margin = "10px";
      delBtn.onclick = async () => {
        if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ØŸ")) {
          await remove(messagesRef);
          alert("âœ… ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø¨Ù†Ø¬Ø§Ø­!");
        }
      };
      document.body.insertBefore(delBtn, document.getElementById("chat"));
    }
  </script>

  <style>
    body {
      font-family: "Cairo", sans-serif;
      background: #0e0e0e;
      color: #eee;
      margin: 0;
      padding: 0;
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      height: 100vh;
    }
    h2 { color:#ffd166;margin:15px 0;font-size:1.3em;}
    #chat {
      flex:1;width:95%;max-width:600px;overflow-y:auto;border:1px solid #333;
      padding:10px;background:#1b1b1b;border-radius:10px;text-align:left;box-sizing:border-box;
    }
    .message{margin-bottom:6px;line-height:1.4;word-wrap:break-word;}
    form{width:95%;max-width:600px;display:flex;gap:5px;margin:10px auto;}
    input{flex:1;padding:10px;border-radius:6px;border:none;outline:none;background:#222;color:#eee;font-size:16px;}
    button{padding:10px 15px;border:none;border-radius:6px;background:#06d6a0;color:#000;font-weight:bold;cursor:pointer;}
    #typing{font-size:14px;color:#aaa;margin:5px;min-height:18px;}
    #users{list-style:none;padding:0;margin:10px 0;width:90%;max-width:400px;}
    #users li{background:#222;margin:5px 0;padding:8px;border-radius:6px;text-align:right;font-weight:600;border-right:6px solid #666;}
  </style>
</head>
<body>
  <h2>ğŸ’¬ Ø¯Ø±Ø¯Ø´Ø© Ù…Ø¤Ù‚ØªØ©</h2>
  <div id="chat"></div>
  <div id="typing"></div>
  <form id="chatForm">
    <input id="msg" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ..." autocomplete="off" />
    <button>Ø¥Ø±Ø³Ø§Ù„</button>
  </form>
  <h3>Ø§Ù„Ù…ØªØµÙ„ÙˆÙ† Ø§Ù„Ø¢Ù†:</h3>
  <ul id="users"></ul>
</body>
</html>


