
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>ğŸ’¬ Ø¯Ø±Ø¯Ø´Ø© Ù…Ø¤Ù‚ØªØ©</title>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
import { getDatabase, ref, push, set, remove, onValue, onChildAdded, onChildRemoved, onDisconnect, get, update } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";

// ğŸ”¹ Ø¥Ø¹Ø¯Ø§Ø¯ Firebase
const firebaseConfig = {
  apiKey: "AIzaSyDzGM7Zy6JIrFJyDj7s5SjAd-l8rbCe9VE",
  authDomain: "kelta-gmae.firebaseapp.com",
  databaseURL: "https://kelta-gmae-default-rtdb.firebaseio.com",
  projectId: "kelta-gmae",
  storageBucket: "kelta-gmae.firebasestorage.app",
  messagingSenderId: "247464874751",
  appId: "1:247464874751:web:779a3120e6b422fdee72ca",
  measurementId: "G-6C8HGRKLHS"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const usersRef = ref(db, "users");
const messagesRef = ref(db, "messages");
const typingRef = ref(db, "typing");
const gameRef = ref(db, "game_state"); // ğŸ Ø¹Ù‚Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©
const savedUsersRef = ref(db, "savedUsers");
const kickSignalRef = ref(db, "kick_signals"); // ğŸš« Ø¹Ù‚Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ø¥Ø´Ø§Ø±Ø§Øª Ø§Ù„Ø·Ø±Ø¯

const ADMIN_NAME = "KeltA";

// ğŸ¤– Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨ÙˆØª "Ø¨Ø³Ø§Ù…"
const BOT_NAME = "Ø§Ù„Ø¨ÙˆØª Ø¨Ø³Ø§Ù…âœ”";
const BOT_COLOR = "#f30217"; // âœ¨ Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø°ÙŠ Ø³ÙŠØ¸Ù‡Ø± Ø¨Ù‡ Ø§Ø³Ù… Ø§Ù„Ø¨ÙˆØª (Ø­Ø§Ù„ÙŠØ§Ù‹ Ø£Ø­Ù…Ø±)
const BOT_AVATAR_COLOR = "red"; // Ù„ÙˆÙ† Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø£ÙØ§ØªØ§Ø± ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªØµÙ„ÙŠÙ†
const BOT_AVATAR_URL = "https://i.pinimg.com/736x/2a/0d/77/2a0d77e1bf6d19ab336921683544bb35.jpg"; // âœ¨ Ø¶Ø¹ Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© Ø§Ù„Ø¨ÙˆØª Ù‡Ù†Ø§
const BOT_WORDS_LIST = ["Ù‚Ù„Ø¨","Ø±Ù…Ø­","Ø¹Ø´Ø¨","ØµÙ†Ø¯ÙˆÙ‚","Ø­Ø¨Ù„","Ø§Ø´Ø§Ø±Ø©Ù…Ø±ÙˆØ±","Ø«Ø¹Ù„Ø¨","ÙŠØ¶Ø­Ùƒ","Ù‚Ù†ÙØ°","Ø¹Ù„Ù…","Ø¨Ù‚Ø±Ø©","ÙƒÙ„Ø¨","Ø´Ø¨Ø­","Ù‚Ù†Ø¨Ù„Ø©","Ù†Ø¹Ø§Ù…Ø©","Ø³Ø¬Ù‚","Ø¯ÙŠÙƒ","Ù‚Ø·Ø§ÙŠÙ","Ø±ÙˆØ¨ÙˆØª","Ø¹Ø´Ø¨","Ø¨Ø·Ø©","ÙŠÙ…Ø´ÙŠ","Ø§Ø¨Ø±Ø©","Ø°Ø¦Ø¨","Ù†Ø§ÙØ°Ø©","ÙØ±Ø´Ø©","ØµØ­Ù†","Ø¨Ø·Ø±ÙŠÙ‚","Ù…Ù„Ùƒ","Ø³ÙƒØ±","Ø¨Ø±Ø¬Ø§ÙŠÙÙ„","Ù…Ø²Ø±Ø¹Ø©","Ù…Ù„ÙÙˆÙ","Ø±ÙˆØ¨ÙŠØ§Ù†","Ù…ÙƒØ©","Ù…Ù†Ø¯ÙŠ","Ø«Ù„Ø¬","Ø°Ø¨Ø§Ø¨Ø©","Ø·Ø§ÙˆÙ„Ø©","Ù…ÙŠÙƒØ§Ù†ÙŠÙƒÙŠ","Ø¬Ø¯Ø§Ø±","Ø§ÙŠØ³ÙƒØ±ÙŠÙ…","Ø³ÙƒÙŠÙ†","Ù…Ø§Ø¹Ø²","ÙƒØ±Ø©Ø³Ù„Ø©","Ø¨Ø·Ø§Ø·Ø§","Ù…Ù„Ùƒ","Ø§ØµØ¨Ø¹","Ø³Ø±ÙˆØ§Ù„","Ø¨ØµÙ„","Ø³Ù„Ùƒ","Ø³Ø§Ø¦Ù‚","Ø·Ù…Ø§Ø·Ù…","ÙƒÙ†Ø§ÙØ©","Ø§Ø°Ù†","Ø¬ÙˆØ§Ù„","Ù†Ù…Ø±","Ø·Ø§ÙˆÙˆØ³","Ø«ÙˆØ±","Ø®ÙˆØ®","ØªÙˆØµÙŠÙ„Ø©","Ù‚Ù…Ø±","Ø´Ø§Ø±Ø¹","Ù…Ù†Ø³Ù","Ù…Ø§Ù†Ø¬Ùˆ","Ø¯Ù…","Ù…Ø§Ø¡","Ø·ÙŠØ§Ø±","Ø¹ÙˆØ¯","Ø¨Ø§Øµ","Ø¬Ø²ÙŠØ±Ø©","ØªØ§Ø¬","Ø¹ØµØ§","ØªÙ…Ø³Ø§Ø­","Ù‚Ø¯Ù…","Ø¨ÙŠØ¶","Ø­Ø²ÙŠÙ†","ÙØ£Ø³","Ù‡Ø§ØªÙ","Ø­ÙˆØª","Ø±ÙˆØ¨ÙŠØ§Ù†","Ø¸ÙØ±","Ù‚ÙÙ„","Ø³Ø§Ø¹Ø©","Ø¹Ø³Ù„","Ø¬ÙˆØ²Ø§Ù„Ù‡Ù†Ø¯","ÙƒÙ†Ø¨","Ø¹ØµÙÙˆØ±","ÙØ·Ø±","Ù‚Ø·Ù‡","Ù…Ø®Ø¯Ø©","Ø´Ø§ÙˆØ±Ù…Ø§","ØªÙˆØª","Ù…Ø³Ø·Ø±Ø©","ÙØ±Ø§ÙˆÙ„Ø©","Ù‡Ø¯Ù‡Ø¯","Ù‚Ø±Ø¯","Ø²Ù‡Ø±Ø©","Ø°Ø±Ø©","Ù…ÙƒØªØ¨","Ø¯ÙˆÙ„Ø§Ø¨","ÙÙŠØ´","ÙØ´Ø§Ø±","Ø³Ù…Ø§Ø¡","ÙŠØ³Ø¨Ø­","ÙÙŠÙ„","ØªÙ†ÙŠÙ†","Ø´Ø±ÙŠØ·","Ø°Ù‡Ø¨","Ø§Ù„Ø§Ø±Ø¶","Ø¨Ø±ÙˆÙƒÙ„ÙŠ","ØºÙŠÙˆÙ…","Ø´ÙˆÙƒÙˆÙ„Ø§ØªÙ‡","Ø¨Ø±Ø¬Ø±","ÙÙ„ÙˆØ³","ÙˆØ­ÙŠØ¯Ø§Ù„Ù‚Ø±Ù†","ÙØ§Ù†ÙˆØ³","Ø³Ù†Ø¬Ø§Ø¨","Ù…Ù„Ø¹Ù‚Ø©","Ù…Ù„Ø¹Ù‚Ø©","Ø®Ø±ÙŠØ·Ø©","ØµØ±ØµÙˆØ±","Ù…Ù†Ø¯ÙŠÙ„","ÙƒØ§ØªØ´Ø¨","Ù…ØµØ§ØµØ©","Ø¯Ø¨Ù‚Ø·Ø¨ÙŠ","Ù†ÙŠØ²Ùƒ","Ø±Ù…Ø§Ù†","Ø´Ø§Ø±Ø¹","Ø¹Ù‚Ø±Ø¨","Ø­Ù…Ø§Ø±","Ø¹ØµÙÙˆØ±","ØªÙ„ÙØ§Ø²","Ø­ÙØ±Ø©","Ù†Ø§Ø±","Ø­Ù‚ÙŠØ¨Ø©","Ø·Ø§ÙˆÙ„Ù‡","ÙƒØ±Ø©Ù‚Ø¯Ù…","Ø¯Ø±Ø¹","Ø¯Ø¨","Ø¨Ù‚Ù„Ø§ÙˆØ©","Ø§Ù†Ø§Ù†Ø§Ø³","Ø³Ø±ÙŠØ±","Ø²ÙŠØªÙˆÙ†","ØºÙˆØ±ÙŠÙ„Ø§","Ø³Ù„Ù…","Ø´Ø§Ø­Ù†Ø©","Ù…Ø³Ø¬Ø¯","Ø¹ØµØ§","Ø¨Ø±ÙƒØ§Ù†","Ù‚Ø¯Ù…","Ù‚ÙˆØ³","Ø´Ø·Ø±Ù†Ø¬","ØªØ§Ø¬","Ø¹Ø§Ù…Ù„Ù†Ø¸Ø§ÙØ©","ØºØ³Ø§Ù„Ø©","Ù…Ù†Ø´Ø§Ø±","Ø­ÙˆØª","Ù…Ø³Ø¯Ø³","Ø¨Ø§Ø¨","Ø¯Ù…ÙŠØ©","Ø¬Ø§Ù…ÙˆØ³","Ø¹Ø§Ø¦Ù„Ø©","Ù„ÙŠÙ„","Ø­Ø°Ø§Ø¡","Ø²Ø±Ø§ÙØ©","Ø·Ø§Ø¨Ø¹Ø©","Ù†Ù…Ù„","Ø¯ÙˆÙ„Ø§Ø¨","Ø®ÙŠØ§Ø±","Ø´ÙˆØ±Ø¨Ø©","Ø³ØªØ§Ø±Ø©","ÙƒÙŠØ³","Ø±ÙŠÙ…ÙˆØª","Ø¯Ø¨Ø§Ø³Ø©","Ø³Ù„Ø·Ø¹ÙˆÙ†","Ø¨Ø§Ø°Ù†Ø¬Ø§Ù†","Ù…Ø²Ù‡Ø±ÙŠØ©","Ù…Ø®Ø¯Ø©","Ø³ÙŠÙ","Ù…ÙƒØªØ¨Ø©","ÙˆØ±Ù‚Ø©","Ù…ÙƒØªØ¨","ÙØ³ØªØ§Ù†","Ù…Ø´Ù…Ø´","ÙƒÙˆØ¨","ÙƒØ´Ø±ÙŠ","Ø³Ù„Ø­ÙØ§Ø©","Ø­Ù„ÙŠØ¨","Ù…Ø¬Ø±Ø©","Ù†Ø³Ø±","ØºÙˆØ§ØµØ©","Ø®Ø´Ø¨","Ù†Ø¸Ø§Ø±Ø©","Ø§ÙÙˆÙƒØ§Ø¯Ùˆ","Ù‚Ø§Ø±Ø¨","Ø¨ÙŠØ§Ù†Ùˆ","Ø°Ø±Ø©","Ù…Ø³Ø±Ø­","Ø´Ù†Ø¨","Ø§Ø³Ù†Ø§Ù†","Ø§Ù†Ù","Ù…Ø±ÙˆØ­Ø©","Ù‚Ù‡ÙˆØ©","ÙÙ‚Ù…Ø©","Ø³Ø±ÙŠØ±","Ø­Ø¯ÙŠÙ‚Ø©","Ø¨Ù„ÙŠØ§Ø±Ø¯Ùˆ","Ø³Ø§Ø¹Ø©Ø±Ù…Ù„ÙŠØ©","Ù†Ù‡Ø±","Ù‚Ù†ÙØ°","ÙÙˆÙ„","ÙÙ„Ø§Ø´Ø©","Ù…ØµØ¨Ø§Ø­","Ù„Ø³Ø§Ù†","Ø³ÙŠØ§Ø±Ø©","Ù‚Ù„Ù…Ø±ØµØ§Øµ","Ø³Ù…ÙƒØ©","ÙƒÙˆÙƒÙŠØ²","Ø·Ø§Ø¦Ø±Ø©","Ø¶ÙØ¯Ø¹","ÙƒØ§Ù…ÙŠØ±Ø§","ØªÙ…Ø±","Ø®Ø´Ø¨","Ø´Ø±Ø§Ø¨","Ø¹ÙŠÙ†","ÙƒÙˆØ§Ù„Ø§","Ø²Ø±","Ø¨Ø§Ù…ÙŠØ©","Ø¶Ø¨Ø¹","ÙŠØ¨ÙƒÙŠ","ØºØ±Ø§Ø¨","Ø®Ø¨Ø²","Ù…Ø³Ù…Ø§Ø±","Ù…ÙˆÙŠØ©","Ù†Ø®Ù„Ø©","ÙƒØ±Ø²","Ø¨ÙŠØªØ²Ø§","Ø´ÙˆÙƒØ©","Ø¯ÙƒØªÙˆØ±","Ù…Ø±Ø¢Ø©","Ù…Ø§ÙŠÙƒ","Ø·Ø±ÙŠÙ‚","Ù…ØºÙ†ÙŠ","ØºØ§Ø¨Ø©","Ø¬Ø¨Ù„","Ù‡ÙŠÙƒÙ„Ø¹Ø¸Ù…ÙŠ","Ø¨Ø­Ø±","Ù…Ø¸Ù„Ø©","ÙƒØ¨Ø©","Ù„Ø§Ø¹Ø¨","Ø®Ø³","Ø³Ø§Ø¹Ø©","Ø¨Ø±Ø¬Ø®Ù„ÙŠÙØ©","Ø¬Ø²Ø±","ÙˆØ³Ø§Ø¯Ø©","Ø®ÙŠÙ…Ø©","Ø®ÙŠØ§Ø·","Ø³Ø¨Ø§Ù†Ø®","Ø±Ù‚Øµ","Ø¯Ø¬Ø§Ø¬","ØµÙŠØ¯Ù„ÙŠ","Ø§Ø·ÙØ§Ø¦ÙŠ","ÙƒØ¨Ø³Ø©","ÙƒÙŠØ¨ÙˆØ±Ø¯","Ø·Ø§ÙˆÙ„Ø©","Ø³Ø¬Ø§Ø¯Ù‡","Ù…Ø­ÙØ¸Ø©","Ø®Ù†Ø²ÙŠØ±","ÙƒØ±Ø©","Ø¹Ù†Ø¨","Ø´Ø§Ø´Ø©","Ù‚Ø§Ø¶ÙŠ","Ø°Ø¦Ø¨","Ø´Ø¬Ø±Ø©","Ø´Ø§ÙŠ","Ù†Ø¹Ø§Ù„","Ù†Ø¬ÙˆÙ…","ÙØ±Ø§Ø®","ÙÙ„ÙÙ„","Ù†Ø­Ù„Ø©","Ø´Ø§Ù…Ø¨Ùˆ","Ø®ÙØ§Ø´","ÙƒÙ†Ø²","Ù‚ÙˆØ³Ù‚Ø²Ø­","Ø§ØµØ¨Ø¹","Ø§Ø®Ø·Ø¨ÙˆØ·","Ù…Ø­Ø§Ø³Ø¨","ÙƒØªØ§Ø¨","Ø·Ø¨Ø§Ø®","Ø¨Ø±Ù‚","ØºØ²Ø§Ù„","Ø®Ø§ØªÙ…","Ø¹Ø¸Ù…","ÙØ·ÙŠØ±Ø©","Ø¯ÙØªØ±","Ø¨Ø¨ØºØ§Ø¡","Ø¬Ù…Ù„","Ø·Ø±ÙŠÙ‚","Ø¨Ø±ØªÙ‚Ø§Ù„","Ø­Ù…Ø§Ø±ÙˆØ­Ø´ÙŠ","Ø²Ø¨Ø§Ù„Ø©","Ø§Ù„Ù…Ø§Ø³","ÙƒØ±Ø©","ØºØ±ÙØ©","Ø³ØªÙŠÙƒ","Ø­Ù„Ø§ÙˆØ©","Ù†Ù‚Ø§Ù†Ù‚","Ø¯ÙˆØ¯Ø©","Ù…Ù„Ø¹Ø¨","ÙƒØ±Ø©Ø³Ù„Ø©","Ù…Ù…Ø«Ù„","Ø²ÙŠØª","ÙƒÙ†Ø¨Ø©","ÙƒØªØ§Ø¨","Ù…Ø¯Ø±Ø³Ø©","Ø§Ù„Ù…Ø§Ø³","Ø§Ù„ÙƒØ¹Ø¨Ø©","ÙŠØ¶Ø­Ùƒ","Ù…ÙƒÙŠØ§Ø¬","Ø¨Ø³ÙƒÙˆØª","Ø³Ù…Ø¨ÙˆØ³Ø©","Ø´Ø§Ø­Ù†","Ø¬Ø¨Ù†","Ø´Ù…Ø§Ù…","Ù…Ø°ÙŠØ¹","ØµØ­Ø±Ø§Ø¡","ÙØ±Ø´Ø§Ø©","Ø­Ù…Ø§Ù…","Ø¨ÙˆÙ…Ø©","Ø³ÙŠÙ","Ù„ÙŠÙ„","Ù…ÙˆØ²","ØµØ¨Ø§Ø±","ÙˆØ­Ø´","Ø¬Ø§ÙƒÙŠØª","Ø¬ÙˆØ§ÙØ©","Ø¨Ø·Ø§Ø±ÙŠØ©","Ø´Ù…Ø¹Ø©","Ù„ÙŠÙ…ÙˆÙ†","Ø¬ÙˆÙ‡Ø±Ø©","Ù…Ø¹Ø¯Ø©","Ø´Ø§Ø·Ø¦","Ø¨Ø§Ù†Ø¯Ø§","Ø¯ÙˆÙ†Ø§Øª","ÙØ±Ø§Ø´Ø©","Ø§Ø±Ù†Ø¨","Ø§Ø³Ø¯","Ø³ÙÙŠÙ†Ø©","Ø¹ØµÙŠØ±","Ù†Ø¬ÙˆÙ…","ÙˆÙ„Ø§Ø¹Ø©","Ù…ÙƒØ±ÙˆÙ†Ø©","Ø«ÙˆØ¨","Ø³ÙƒÙŠÙ†","Ù‚Ø¯Ø±","ØªØ¨ÙˆÙ„Ø©","Ø¨Ø·ÙŠØ®","ÙˆØ³Ø§Ø¯Ø©","Ø§Ø¨Ø±Ø©","Ø³ÙˆØ´ÙŠ","ØµØ§Ø±ÙˆØ®","Ø¬Ø§Ù„Ø³","Ø³Ù…Ø§Ø¹Ø©","Ø´Ø±Ø·ÙŠ","Ù…ÙƒÙŠÙ","Ù‚Ø·Ø©","Ù…Ù‚Ù„ÙˆØ¨Ø©","Ù…Ù‚Øµ","Ø¯Ø¬Ø§Ø¬Ù…Ø´ÙˆÙŠ","ÙØ£Ø³","ÙØ±Ø³Ø§Ù„Ù†Ù‡Ø±","Ø·Ø¨Ù„","ÙŠØ±ÙƒØ¶","Ù…ÙƒÙ†Ø³Ø©","Ù‚Ù„Ù…Ø±ØµØ§Øµ","Ø­Ø§Ø¬Ø¨","Ø§Ø¹ØµØ§Ø±","ÙƒÙˆØ®","Ø´ÙˆÙƒØ©","Ù…Ø·Ø±","ÙÙ‡Ø¯","Ù‚Ø¨Ø¹Ø©","Ø«Ø¹Ø¨Ø§Ù†","Ø±Ø³Ø§Ù…","ØºÙŠÙˆÙ…","Ø­Ù…Øµ","ÙŠØ¯","Ø¹Ù†ÙƒØ¨ÙˆØª","Ø¨Ø±ÙŠØ§Ù†ÙŠ","Ø³Ø­Ù„ÙŠØ©","Ù„Ø­Ù…","ÙˆØ±Ø¯Ø©","Ù…Ø·Ø¹Ù…","Ø¬Ø±Ø³","Ø³Ø¨ÙˆØ±Ø©","Ø¨Ø·Ù†","Ù‚Ø§Ø±ÙˆØ±Ø©","Ø³ÙŠÙ†Ù…Ø§","Ù…Ù‡Ù†Ø¯Ø³","Ø¹Ø·Ø±","ÙˆØ±Ù‚Ø¹Ù†Ø¨","Ù…Ø¹Ù„Ù…","Ù…Ù…Ø±Ø¶Ø©","Ø³Ù„Ù…","Ù…Ø·Ø±","Ø¹ØµØ§","ÙƒØ±ÙŠØ¨","Ø¨Ø±Ù‚","Ù‚Ø·Ø§Ø±","ÙƒØ¨Ø§Ø¨","Ø·ÙÙ„","Ø´Ù„Ø§Ù„","ÙŠØ¨ÙƒÙŠ","Ø³Ù„Ø·Ø©","Ø³Ø¬Ø§Ø¯Ø©","Ù…Ø´Ø·","Ù‚Ø¨Ø¹Ø©","Ø®Ù„Ø§Ø·","Ù†ÙˆÙ…","Ø´ØªØ§Ø¡","Ø­Ø²ÙŠÙ†","Ù„ÙŠÙ„","Ø«Ù„Ø§Ø¬Ø©","ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠ","ÙƒØ£Ø³","Ø´Ø§ÙŠ","Ø¬Ø§Ù…Ø¹Ø©","Ø¨Ø±Ø¬","ØªÙØ§Ø­","Ø¹Ø´Ø¨","Ø¨Ø·Ù‡","Ø¬Ù…Ø¬Ù…Ø©","ÙƒØ±Ø³ÙŠ","Ø¨Ø·Ø§Ø·Ø³","Ø¨Ø³ÙƒÙˆØª","Ù…ÙƒÙ†Ø³Ø©","ÙƒÙŠÙƒ","Ø§ÙÙˆÙƒØ§Ø¯Ùˆ","ØµØ§Ø¨ÙˆÙ†","Ù‚Ù…Ø±","Ù‡Ø±Ù…","Ø³Ø§Ø¹Ø©ÙŠØ¯","ÙƒÙˆÙƒØ¨","Ù„Ø§Ø¨ØªÙˆØ¨","Ø´Ù†Ø·Ø©","Ø¹Ù…Ø§Ø±Ø©","Ø¨ÙŠØª","Ø¯ÙŠÙ†Ø§ØµÙˆØ±","ÙØ±Ù†","Ø±Ø²","Ù…ÙØªØ§Ø­","Ø±Ù…ÙˆØ´","Ø¬ÙˆØ§Ø±Ø¨","Ù…Ø¯ÙŠÙ†Ø©","Ù‚Ù„Ù…","Ø³Ù„Ø©","Ø­ØµØ§Ù†","Ø²ÙˆÙ…Ø¨ÙŠ","Ù†Ø¬Ù…Ø©","Ø¹Ù„Ø¨Ø©","Ù…Ø·Ø¨Ø®","ÙØ§ØµÙˆÙ„ÙŠØ§","Ù‚Ù‡ÙˆØ©","ÙƒÙ…Ø¨ÙŠÙˆØªØ±","Ù…Ù„ÙˆØ®ÙŠØ©","Ù‚Ù…ÙŠØµ","Ù…Ø±Ø­Ø§Ø¶","ÙÙ…","ØµÙ‚Ø±","Ø·Ø§ÙˆÙ„Ù‡"]; // Ù‚Ø§Ø¦Ù…Ø© ÙƒÙ„Ù…Ø§Øª Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„
let savedBotWords = JSON.parse(localStorage.getItem("savedBotWords")) || [];

// ğŸ Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ© (ØªØªÙ… Ù…Ø²Ø§Ù…Ù†ØªÙ‡Ø§ Ù…Ø¹ Firebase)
let localGameState = {
    inProgress: false,         // Ù‡Ù„ Ø§Ù„Ù„Ø¹Ø¨Ø© Ø¬Ø§Ø±ÙŠØ©ØŸ
    countdownActive: false,    // Ù‡Ù„ Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ Ù†Ø´Ø·ØŸ
    gameWords: [],             // Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„Ù„Ø¹Ø¨Ø©
    gameStartTime: 0,          // ÙˆÙ‚Øª Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø© Ø§Ù„ÙØ¹Ù„ÙŠ (Ø¨Ø¹Ø¯ Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ)
    lastGameId: null,          // Ù…Ø¹Ø±Ù ÙØ±ÙŠØ¯ Ù„ÙƒÙ„ Ø¬ÙˆÙ„Ø© Ù„Ø¹Ø¨Ø© Ù„Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±
    countdownMessagesSent: false, // ğŸ†• Ù„ØªØªØ¨Ø¹ Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ Ù‚Ø¯ Ø£ÙØ±Ø³Ù„Øª
    winnerAnnounced: false,    // ğŸ†• Ù„ØªØªØ¨Ø¹ Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ÙØ§Ø¦Ø² Ù‚Ø¯ Ø£ÙØ¹Ù„Ù†
    wordCount: 5               // ğŸ”¹ Ø¹Ø¯Ø¯ Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø´ØªØ±Ùƒ Ù„Ù„Ø¹Ø¨Ø©ØŒ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© 5
};

// ğŸš© Ù…ØªØºÙŠØ± Ù…Ø­Ù„ÙŠ Ù„ØªØªØ¨Ø¹ Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù‚Ø¯ Ø¨Ø¯Ø£ Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ Ù„Ø¬ÙˆÙ„Ø© Ù…Ø¹ÙŠÙ†Ø©
// Ù‡Ø°Ø§ ÙŠØ¶Ù…Ù† Ø£Ù† Ø¹Ù…ÙŠÙ„Ù‹Ø§ ÙˆØ§Ø­Ø¯Ù‹Ø§ ÙÙ‚Ø· ÙŠÙ‚ÙˆÙ… Ø¨ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø¥Ù„Ù‰ Firebase
let initiatedCountdownGameId = null;

// ğŸ”¹ Ù…Ù†Ø¹ ØªØ¹Ø¯Ø¯ Ø§Ù„Ø¬Ù„Ø³Ø§Øª (Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª)
const channel = new BroadcastChannel('chat_session_channel');
let isPrimaryTab = false;

window.addEventListener('load', () => {
    // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø¨Ø£Ù† Ù‡Ø°Ø§ Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ù…ÙˆØ¬ÙˆØ¯
    channel.postMessage('new_tab_opened');
});

channel.onmessage = (event) => {
    if (event.data === 'new_tab_opened' && !isPrimaryTab) {
        // ØªØ¨ÙˆÙŠØ¨ Ø¢Ø®Ø± ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ù‹Ø§ Ù‚Ø¨Ù„ÙŠØŒ Ø¥Ø°Ù† Ù‡Ø°Ø§ Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ù…ÙƒØ±Ø±
        document.body.innerHTML = `<div style="text-align: center; padding: 50px; font-size: 1.5em; color: #ff6b6b;">
            <h1>ğŸš« Ø¬Ù„Ø³Ø© Ù…ÙƒØ±Ø±Ø©</h1>
            <p>ÙŠÙ…ÙƒÙ† ÙØªØ­ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© ÙÙŠ ØªØ¨ÙˆÙŠØ¨ ÙˆØ§Ø­Ø¯ ÙÙ‚Ø· ÙÙŠ ÙƒÙ„ Ù…Ø±Ø©.</p>
        </div>`;
        // Ø¥ÙŠÙ‚Ø§Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø§ØªØµØ§Ù„Ø§Øª ÙˆØ§Ù„Ø¹Ù…Ù„ÙŠØ§Øª
        channel.close();
        throw new Error("Duplicate tab detected. Halting script execution.");
    }
};
isPrimaryTab = true; // Ù‡Ø°Ø§ Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ù‡Ùˆ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ

// ğŸ”¹ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¹Ø±Ù ÙØ±ÙŠØ¯ Ù„Ù„Ø¬Ù‡Ø§Ø²
let deviceId = localStorage.getItem("chat_device_id") || "dev_" + Math.floor(Math.random()*1e9);
localStorage.setItem("chat_device_id", deviceId);

// ğŸ”¹ Ø§Ø®ØªÙŠØ§Ø± Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
async function chooseUsername() {
  let username = localStorage.getItem("chat_username");
  const savedData = (await get(savedUsersRef)).val() || {};
  if(username && savedData[username]?.deviceId===deviceId) return username;

  let valid=false;
  while(!valid){
    username = prompt("Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ:")?.trim();
    if(!username) continue;
    const usersData = (await get(usersRef)).val() || {};
    const nameTaken = Object.values(usersData).some(u=>u.name===username);
    const nameSavedElsewhere = savedData[username] && savedData[username].deviceId!==deviceId;
    if(nameTaken || nameSavedElsewhere) continue;
    valid=true;
  }
  localStorage.setItem("chat_username", username);
  return username;
}

const username = await chooseUsername();

// ğŸ”¹ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù„ÙˆÙ† ÙˆØ­ÙØ¸Ù‡
const colors = ["#ffadad","#ffd6a5","#fdffb6","#caffbf","#9bf6ff","#a0c4ff","#bdb2ff","#ffc6ff"];
const userColor = colors[Math.floor(Math.random()*colors.length)];
await set(ref(db, "savedUsers/"+username), {color:userColor, deviceId});

// ğŸ”¹ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
// ğŸ”¹ Ø§Ø³ØªØ®Ø¯Ø§Ù… userId Ù…Ù† localStorage Ù„Ù…Ù†Ø¹ Ø§Ù„Ø§Ø³ØªÙ†Ø³Ø§Ø® Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ø¯ÙŠØ«
let userId = localStorage.getItem("chat_userId") || "user_" + Math.floor(Math.random() * 1e9);
localStorage.setItem("chat_userId", userId);
const userRef = ref(db, "users/"+userId);
function isMobileDevice() {
    return /Mobi|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
}
const deviceType = isMobileDevice() ? 'mobile' : 'desktop';

// ğŸ”¹ Ø¬Ù„Ø¨ IP Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØªØ®Ø²ÙŠÙ†Ù‡
let userIP = "N/A"; // Ù‚ÙŠÙ…Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ© ÙÙŠ Ø­Ø§Ù„ ÙØ´Ù„ Ø§Ù„Ø¬Ù„Ø¨
try {
    const response = await fetch('https://api.ipify.org?format=json');
    const data = await response.json();
    userIP = data.ip;
} catch (error) {
    console.error("Failed to fetch IP address:", error);
}

// ğŸ”¹ Ø¯Ø§Ù„Ø© Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø£Ùˆ Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
async function registerUserPresence() {
    const userRecord = {
        name: username,
        color: userColor,
        online: true,
        lastSeen: Date.now(),
        device: deviceType,
        ip: userIP,
        deviceId: deviceId
    };
    // Ù‚Ù… Ø¨Ø¥Ù„ØºØ§Ø¡ Ø£ÙŠ Ø¹Ù…Ù„ÙŠØ§Øª onDisconnect Ù‚Ø¯ÙŠÙ…Ø© Ù‚Ø¨Ù„ ØªØ¹ÙŠÙŠÙ† ÙˆØ§Ø­Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø©
    await onDisconnect(userRef).cancel();
    // Ù‚Ù… Ø¨ØªØ¹ÙŠÙŠÙ† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ£Ù…Ø± Ø§Ù„Ø­Ø°Ù Ø¹Ù†Ø¯ Ø§Ù„Ø§Ù†Ù‚Ø·Ø§Ø¹
    await set(userRef, userRecord);
    onDisconnect(userRef).remove();
}

// Ù‚Ù… Ø¨ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙˆÙ„ÙŠ
await registerUserPresence();
// Ù‚Ù… Ø¨ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© "Ù…ØªØµÙ„" ÙƒÙ„ 5 Ø«ÙˆØ§Ù†Ù
setInterval(() => update(userRef, { online: true, lastSeen: Date.now() }), 5000);

// Ø¹Ù†Ø§ØµØ± Ø§Ù„ØµÙØ­Ø©
const chatBox=document.getElementById("chat");
const form=document.getElementById("chatForm");
const msgInput=document.getElementById("msg");
const typingBox=document.getElementById("typing");
const userList=document.getElementById("users");

// ğŸ”¹ ØµÙˆØª Ù†Ù‚Ø±Ø© Ù‡Ø§Ø¯Ø¦Ø© (Ù…ÙˆÙ„Ø¯ ØµÙˆØªÙŠ ØµØºÙŠØ± Ø¹Ø¨Ø± Web Audio)
let audioEnabled = false;
const AudioCtx = window.AudioContext || window.webkitAudioContext;
const audioCtx = new (AudioCtx)();
document.addEventListener('click', ()=>{
  audioEnabled = true;
  if(audioCtx.state === 'suspended') audioCtx.resume();
}, {once: true});

// Ù…ÙˆÙ„Ø¯ Ù†Ù‚Ø±Ø© Ù‚ØµÙŠØ±Ø© Ù‡Ø§Ø¯Ø¦Ø© (Ø¶ÙˆØ¶Ø§Ø¡ Ù…Ø´Ø·ÙˆÙØ©)
function playClickNoise({volume = 0.05, duration = 0.018} = {}){
  if(!audioEnabled) return;
  try{
    const sampleCount = Math.max(64, Math.floor(audioCtx.sampleRate * duration));
    const buffer = audioCtx.createBuffer(1, sampleCount, audioCtx.sampleRate);
    const data = buffer.getChannelData(0);
    for(let i=0;i<sampleCount;i++){
      const env = Math.exp(-6 * (i / sampleCount));
      data[i] = (Math.random() * 2 - 1) * env * 0.7;
    }
    const src = audioCtx.createBufferSource();
    src.buffer = buffer;
    const g = audioCtx.createGain();
    g.gain.value = volume;
    src.connect(g);
    g.connect(audioCtx.destination);
    src.start();
    src.stop(audioCtx.currentTime + duration + 0.01);
  }catch(e){ /* silent failure */ }
}

// Ù…ÙˆÙ„Ø¯ Ù†ØºÙ…Ø© Ù‚ØµÙŠØ±Ø© (Ù„ØªÙ…ÙŠÙŠØ² Ø§Ù„Ø®Ø±ÙˆØ¬)
function playBeep({freq = 700, volume = 0.04, duration = 0.06} = {}){
  if(!audioEnabled) return;
  try{
    const osc = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    osc.type = 'sine';
    osc.frequency.value = freq;
    g.gain.value = volume;
    // Ù„ÙÙ‘ Ø³Ø±ÙŠØ¹ Ù„Ù„Ù€ gain Ù„Ø¥ØªÙ‚Ø§Ù† Ø§Ù„Ù†ØºÙ…Ø©
    g.gain.setValueAtTime(0.0001, audioCtx.currentTime);
    g.gain.exponentialRampToValueAtTime(volume, audioCtx.currentTime + 0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + duration);
    osc.connect(g);
    g.connect(audioCtx.destination);
    osc.start();
    osc.stop(audioCtx.currentTime + duration + 0.01);
  }catch(e){ /* silent failure */ }
}

// Ø¯ÙˆØ§Ù„ Ù…Ø±ÙŠØ­Ø© Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙÙŠ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…/Ø§Ù„Ù…ØºØ§Ø¯Ø±Ø©
const playJoin = ()=> playClickNoise({volume:1, duration:0.018});
const playLeave = ()=> playBeep({freq:560, volume:1, duration:0.06});

// ğŸ”¹ Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…Ø¹ Ø­Ø§Ù„Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø©
function renderUsers(users, typingUsers){
  userList.innerHTML = "";

  // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨ÙˆØª "Ø¨Ø³Ø§Ù…" Ø¥Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªØµÙ„ÙŠÙ† Ø¨Ø´ÙƒÙ„ Ø¯Ø§Ø¦Ù…
  const botLi = document.createElement("li");
  botLi.innerHTML = `<img src="${BOT_AVATAR_URL}" class="user-list-avatar"> ${BOT_NAME}`;
  botLi.style.borderRight = `6px solid ${BOT_AVATAR_COLOR}`;
  botLi.style.fontWeight = "bold";
  userList.appendChild(botLi);


  // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠÙŠÙ†
  Object.entries(users).forEach(([id,u])=>{
    const li = document.createElement("li");
    let typingAnim = "";
    if(typingUsers[id]){
      typingAnim = `<span class="dots">â€¦</span>`;
    }
    const deviceEmoji = u.device === 'mobile' ? 'ğŸ“±' : 'ğŸ’»';
    // ğŸ”¹ Ø¹Ø±Ø¶ IP Ù„Ù„Ù…Ø¯ÙŠØ± ÙÙ‚Ø·
    let userDetails = `${deviceEmoji} ${u.name} ${typingAnim}`;
    if (username === ADMIN_NAME && u.ip) {
        userDetails += ` <span style="color: #ffcc00; font-size: 0.8em;">(${u.ip})</span>`;
    }
    li.innerHTML = userDetails;
    li.style.borderRight = `6px solid ${u.color}`;

    // ğŸš« Ø¥Ø¶Ø§ÙØ© Ø²Ø± Ø§Ù„Ø·Ø±Ø¯ Ù„Ù„Ù…Ø¯ÙŠØ± ÙÙ‚Ø·
    if (username === ADMIN_NAME && u.name !== ADMIN_NAME) {
        const kickButton = document.createElement("button");
        kickButton.textContent = "ğŸš«";
        kickButton.className = "kick-button";

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ deviceId Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø²Ø±
        if (u.deviceId) {
            kickButton.title = `Ø·Ø±Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ${u.name}`;
            kickButton.onclick = (e) => {
                e.stopPropagation(); // Ù…Ù†Ø¹ Ø£ÙŠ Ø£Ø­Ø¯Ø§Ø« Ù†Ù‚Ø± Ø£Ø®Ø±Ù‰
                if (confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø·Ø±Ø¯ ${u.name}ØŸ`)) {
                    const signalId = "kick_" + Date.now();
                    set(ref(db, `kick_signals/${signalId}`), { targetDeviceId: u.deviceId });
                    setTimeout(() => remove(ref(db, `kick_signals/${signalId}`)), 5000);
                }
            };
        } else {
            // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† deviceId Ù…ÙˆØ¬ÙˆØ¯Ù‹Ø§ØŒ ÙŠØªÙ… ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø²Ø±
            kickButton.disabled = true;
            kickButton.title = `Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø·Ø±Ø¯ ${u.name}ØŒ ÙŠØ­ØªØ§Ø¬ Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©.`;
        }
        li.appendChild(kickButton);
    }

    userList.appendChild(li);
  });
}

// ğŸ”¹ Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙˆØ§Ù„ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø­ÙŠØ©
let currentUsers = {};
let currentTyping = {};
onValue(usersRef, snapshot=>{
  currentUsers = snapshot.val() || {};
  renderUsers(currentUsers, currentTyping);
});

// ğŸ”¹ Ø¥Ø´Ø¹Ø§Ø± Ø¹Ù†Ø¯ Ø¯Ø®ÙˆÙ„ ÙˆØ®Ø±ÙˆØ¬ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
onChildAdded(usersRef, snapshot=>{
  const u = snapshot.val();
  if(u.name !== username){
    const div = document.createElement("div");
    div.className="message";
    div.style.fontStyle="italic";
    div.style.color="#55ff55";
    div.textContent = `âœ… ${u.name} Ø§Ù†Ø¶Ù… Ø¥Ù„Ù‰ Ø§Ù„ØºØ±ÙØ©`;
    chatBox.appendChild(div);
    chatBox.scrollTop = chatBox.scrollHeight;
    if(audioEnabled) playJoin();
  }
});
onChildRemoved(usersRef, snapshot=>{
  const u = snapshot.val();
  const div = document.createElement("div");
  div.className="message";
  div.style.fontStyle="italic";
  div.style.color="#ff5555";
  div.textContent = `âŒ ${u.name} ØºØ§Ø¯Ø± Ø§Ù„ØºØ±ÙØ©`;
  chatBox.appendChild(div);
  chatBox.scrollTop = chatBox.scrollHeight;
  if(audioEnabled) playBeep({freq:1200, volume:0.5, duration:0.04}); // ØµÙˆØª Ø§Ø³ØªÙ„Ø§Ù… Ø±Ø³Ø§Ù„Ø©
  if(audioEnabled) playLeave();
});

// ğŸ”¹ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ù†Ù‚Ø·Ø§Ø¹
onValue(ref(db, '.info/connected'), async (snapshot) => {
    if (snapshot.val() === true) {
        console.log("âœ… ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Firebase.");
        // ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ø§ ÙŠØ²Ø§Ù„ Ù…ÙˆØ¬ÙˆØ¯Ù‹Ø§ØŒ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† ÙƒØ°Ù„ÙƒØŒ Ø£Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„Ù‡
        const userSnapshot = await get(userRef);
        if (!userSnapshot.exists()) {
            console.log("âš ï¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø¹Ø¯ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„ØŒ Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ³Ø¬ÙŠÙ„Ù‡.");
            await registerUserPresence();
        }
    }
});

// ğŸš« Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø¥Ø´Ø§Ø±Ø§Øª Ø§Ù„Ø·Ø±Ø¯
onChildAdded(kickSignalRef, (snapshot) => {
    const signal = snapshot.val();
    // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø¥Ø´Ø§Ø±Ø© ØªØ³ØªÙ‡Ø¯Ù Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø²
    if (signal && signal.targetDeviceId === deviceId) {
        alert("Ù„Ù‚Ø¯ ØªÙ… Ø·Ø±Ø¯Ùƒ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø¯ÙŠØ±.");
        window.location.reload();
    }
});

// ğŸ¤– Ø¯Ø§Ù„Ø© Ù„Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ø¨ÙˆØª
function sendBotMessage(text) {
  push(messagesRef, {
    user: BOT_NAME,
    color: BOT_COLOR,
    userId: "bot_id", // Ù…Ø¹Ø±Ù Ø®Ø§Øµ Ø¨Ø§Ù„Ø¨ÙˆØª
    text: text,
    time: new Date().toLocaleTimeString(), // Ù„Ù„Ø¹Ø±Ø¶
    timestamp: Date.now() // Ù„Ù„Ø·ÙˆØ§Ø¨Ø¹ Ø§Ù„Ø²Ù…Ù†ÙŠØ© Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø© (Ù„Ø¹Ø¨Ø© Ø§Ù„Ø³Ø±Ø¹Ø©)
  });
}

// ğŸ”¹ Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙÙ‚Ø· Ø¨Ø¹Ø¯ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
let firstLoad = true;
onChildAdded(messagesRef, snapshot=>{
  // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙˆÙ„ÙŠ Ù„Ù„ØµÙØ­Ø©ØŒ Ù„Ø§ ØªØ¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©.
  if (firstLoad) return;

  const m = snapshot.val();
  const messageKey = snapshot.key; // Ù…ÙØªØ§Ø­ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„ÙØ±ÙŠØ¯

  // ğŸ¤– Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„ØªØ­ÙŠØ©
  // ÙŠØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„ÙŠØ³Øª Ù…Ù† Ø§Ù„Ø¨ÙˆØªØŒ ÙˆØ§Ù„Ù†Øµ Ù‡Ùˆ "Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ…"ØŒ ÙˆÙ„Ù… ÙŠØªÙ… Ø§Ù„Ø±Ø¯ Ø¹Ù„ÙŠÙ‡Ø§ Ø¨Ø¹Ø¯
  if (m.userId !== "bot_id" && m.text.trim() === "Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ…" && !m.replied) {
    // ÙÙ‚Ø· Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„Ø°ÙŠ Ø£Ø±Ø³Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ© Ù‡Ùˆ Ù…Ù† ÙŠØ±Ø¯
    if (m.userId === userId) {
      // ØªØ£Ø®ÙŠØ± Ø¨Ø³ÙŠØ· Ù„Ø¬Ø¹Ù„ Ø§Ù„Ø±Ø¯ ÙŠØ¨Ø¯Ùˆ Ø·Ø¨ÙŠØ¹ÙŠÙ‹Ø§
      setTimeout(() => {
          sendBotMessage(`ÙˆØ¹Ù„ÙŠÙƒÙ… Ø§Ù„Ø³Ù„Ø§Ù… ÙŠØ§ ${m.user} Ù…Ù†ÙˆÙˆÙˆÙˆÙˆÙˆÙˆÙˆÙˆÙˆÙˆÙˆÙˆÙˆÙˆÙˆÙˆÙˆÙˆÙˆÙˆÙˆÙˆÙˆÙˆÙˆÙˆÙˆÙˆÙˆÙˆÙˆÙˆÙˆÙˆÙˆØ± ğŸ¥³ğŸ‰ğŸ‘‹`);
      }, 500);
    }
    // ÙˆØ¶Ø¹ Ø¹Ù„Ø§Ù…Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ© Ø¨Ø£Ù†Ù‡ ØªÙ… Ø§Ù„Ø±Ø¯ Ø¹Ù„ÙŠÙ‡Ø§ Ù„Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±
    update(ref(db, `messages/${messageKey}`), { replied: true });
  }

  // ğŸ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙØ§Ø¦Ø² ÙÙŠ Ù„Ø¹Ø¨Ø© Ø³Ø±Ø¹Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø©
  // ÙŠØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù„Ø¹Ø¨Ø© Ù‚ÙŠØ¯ Ø§Ù„ØªÙ‚Ø¯Ù…ØŒ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„ÙŠØ³Øª Ù…Ù† Ø§Ù„Ø¨ÙˆØªØŒ Ø§Ù„Ù†Øµ ÙŠØ·Ø§Ø¨Ù‚ ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø©ØŒ ÙˆÙˆÙ‚Øª Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ø¹Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©.
  if (localGameState.inProgress && m.userId !== "bot_id" && m.text.trim() === localGameState.gameWords.join(" ") && m.timestamp >= localGameState.gameStartTime) {
    // Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø© ÙÙŠ Firebase Ø£ÙˆÙ„Ø§Ù‹ Ù„Ù…Ù†Ø¹ Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø§Ù„ÙÙˆØ² Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø©
    // Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø°ÙŠ ÙŠÙ†Ø¬Ø­ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ù‡Ùˆ ÙÙ‚Ø· Ù…Ù† Ø³ÙŠØ¹Ù„Ù† Ø§Ù„ÙØ§Ø¦Ø²
    // ğŸ’¡ Ø§Ø³ØªØ®Ø¯Ø§Ù… 'update' Ù„ØªØºÙŠÙŠØ± ÙÙ‚Ø· Ø§Ù„Ø®ØµØ§Ø¦Øµ Ø§Ù„Ø¶Ø±ÙˆØ±ÙŠØ© ÙˆØ¹Ø¯Ù… Ù…Ø³Ø­ 'gameWords' Ùˆ 'gameStartTime'
    update(gameRef, {
        inProgress: false, // Ø£Ù‡Ù… Ø®Ø·ÙˆØ©: Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù„Ø¹Ø¨Ø© ÙÙˆØ±Ù‹Ø§
        countdownActive: false,
        winnerInfo: { // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙØ§Ø¦Ø²
            user: m.user,
            time: m.timestamp
        }
    });
  }

  // ğŸ”½ Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙÙ‚Ø· ÙÙŠ Ø§Ù„Ø´Ø§Øª
  // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø§ÙˆÙŠØ©
  const msgContainer = document.createElement("div");
  msgContainer.classList.add("message");

  // Ø¥Ø¶Ø§ÙØ© Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ§Ù„Ø±Ø³Ø§Ù„Ø©
  const textDiv = document.createElement("div");
  let nameColor = "white"; // Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ: ÙƒÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¨Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø¨ÙŠØ¶
  let isAdmin = false;

  // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù‡Ùˆ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ØŒ ØºÙŠÙ‘Ø± Ø§Ù„Ù„ÙˆÙ† Ø¥Ù„Ù‰ Ø°Ù‡Ø¨ÙŠ
  if (m.user === ADMIN_NAME) {
    nameColor = "gold";
    isAdmin = true;
  }

  // ğŸ¤– Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ø¨ÙˆØªØŒ Ø§Ø³ØªØ®Ø¯Ù… Ù„ÙˆÙ†Ù‡ Ø§Ù„Ù…Ø­Ø¯Ø¯
  if (m.user === BOT_NAME) {
    nameColor = BOT_COLOR;
  }

  // Ø£Ø¶Ù Ø§Ù„ØªØ§Ø¬ Ø¨Ø¬Ø§Ù†Ø¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ ÙÙ‚Ø· ğŸ‘‘
  textDiv.innerHTML = `
    <strong class="username" style="color:${nameColor}">
      ${m.user}${isAdmin ? " ğŸ‘‘" : ""}:
    </strong> ${m.text}
  `;

  msgContainer.appendChild(textDiv);

  // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠØŒ Ø£Ø¶Ù ÙØ¦Ø© Ø®Ø§ØµØ© Ù„Ù…Ø­Ø§Ø°Ø§ØªÙ‡Ø§ ÙŠÙ…ÙŠÙ†Ù‹Ø§
  if (m.user === username) {
    msgContainer.classList.add("my-message");
  }

  // ğŸ¤– Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ø¨ÙˆØªØŒ Ø£Ø¶Ù ÙØ¦Ø© Ø®Ø§ØµØ©
  if (m.user === BOT_NAME) {
    msgContainer.classList.add("bot-message");
  }

  // ğŸ”¹ Ø¥Ø¶Ø§ÙØ© ØµÙˆØ±Ø© Ø±Ù…Ø²ÙŠØ© Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ§Ø­Ø¯ Ù…Ø­Ø¯Ø¯ (Ù…Ø«Ù„Ø§Ù‹ Ø§Ù„Ù…Ø¯ÙŠØ±)
  if (m.user === ADMIN_NAME) { // â† ØºÙŠÙ‘Ø± Ø§Ù„Ø§Ø³Ù… ÙƒÙ…Ø§ ØªØ±ÙŠØ¯
    const avatar = document.createElement("img");
    avatar.src = "https://i.pinimg.com/1200x/21/3d/f8/213df8f9bc8e0189d0b494a9b195e308.jpg"; // Ø¶Ø¹ Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø±Ù…Ø²ÙŠØ© Ù‡Ù†Ø§
    avatar.classList.add("avatar");
    msgContainer.appendChild(avatar);
  }

  // ğŸ¤– Ø¥Ø¶Ø§ÙØ© ØµÙˆØ±Ø© Ø±Ù…Ø²ÙŠØ© Ù„Ù„Ø¨ÙˆØª
  if (m.user === BOT_NAME) {
    const avatar = document.createElement("img");
    avatar.src = BOT_AVATAR_URL;
    avatar.classList.add("avatar");
    msgContainer.appendChild(avatar);
  }

  chatBox.appendChild(msgContainer);
  chatBox.scrollTop = chatBox.scrollHeight;
});

get(messagesRef).then(()=>{ firstLoad=false; });

// ğŸ”¹ ØªØ­Ø¯ÙŠØ« ÙÙˆØ±ÙŠ Ø¹Ù†Ø¯ Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
onValue(messagesRef, snapshot => {
  if(!snapshot.exists()){
    chatBox.innerHTML = "";
  }
});

// ğŸ Listener Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© Ù…Ù† Firebase
onValue(gameRef, async (snapshot) => {
    const firebaseState = snapshot.val() || {};

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ù„Ù„Ø¹Ø¨Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Firebase
    localGameState = {
        inProgress: firebaseState.inProgress || false,
        countdownActive: firebaseState.countdownActive || false,
        gameWords: firebaseState.gameWords || [],
        gameStartTime: firebaseState.gameStartTime || 0,
        lastGameId: firebaseState.lastGameId || null,
        wordCount: firebaseState.wordCount || 5, // ğŸ”¹ Ù‚Ø±Ø§Ø¡Ø© Ø¹Ø¯Ø¯ Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ù…Ù† Firebase
        countdownMessagesSent: firebaseState.countdownMessagesSent || false, // ğŸ†• ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ©
        winnerAnnounced: firebaseState.winnerAnnounced || false // ğŸ†• ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ©
    };

    // ğŸ¤– Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ø¨ÙˆØª ÙƒÙ…Ù†Ø³Ù‚: Ø£ÙˆÙ„ Ø¹Ù…ÙŠÙ„ ÙŠØ±Ù‰ Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ Ù†Ø´Ø·Ù‹Ø§ ÙŠØªÙˆÙ„Ù‰ Ø§Ù„Ù…Ù‡Ù…Ø©
    if (localGameState.countdownActive && !localGameState.countdownMessagesSent) {
        // ... (The countdown logic remains here)
    }

    // ğŸ† Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ÙØ§Ø¦Ø² Ù„Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„Ù†ØªÙŠØ¬Ø© Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·
    // ÙŠØªÙ… Ù‡Ø°Ø§ Ø§Ù„ØªØ­Ù‚Ù‚ Ø¹Ù†Ø¯ ØªØºÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© Ø¥Ù„Ù‰ "ØºÙŠØ± Ø¬Ø§Ø±ÙŠØ©" ÙˆÙˆØ¬ÙˆØ¯ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙØ§Ø¦Ø²
    if (!firebaseState.inProgress && firebaseState.winnerInfo && !firebaseState.winnerAnnounced) {
        // ğŸ’¡ Ù…Ø­Ø§ÙˆÙ„Ø© "Ø­Ø¬Ø²" Ù…Ù‡Ù…Ø© Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„ÙØ§Ø¦Ø² Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ø¹Ø§Ù…Ù„Ø© Ø°Ø±ÙŠØ©
        // Ù‡Ø°Ø§ ÙŠØ¶Ù…Ù† Ø£Ù† Ø¹Ù…ÙŠÙ„Ù‹Ø§ ÙˆØ§Ø­Ø¯Ù‹Ø§ ÙÙ‚Ø· Ø³ÙŠÙ†Ø¬Ø­ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ØªØ­Ø¯ÙŠØ«
        const { committed, snapshot } = await runTransaction(gameRef, (currentData) => {
            if (currentData && !currentData.winnerAnnounced && currentData.winnerInfo) {
                // Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„ÙØ§Ø¦Ø² Ø¨Ø¹Ø¯ØŒ Ù‚Ù… Ø¨ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©
                currentData.winnerAnnounced = true;
                return currentData; // Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø«Ø© Ù„Ø­ÙØ¸Ù‡Ø§
            }
            // Ø¥Ø°Ø§ ØªÙ… Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„ÙØ§Ø¦Ø² Ø¨Ø§Ù„ÙØ¹Ù„ Ù…Ù† Ù‚Ø¨Ù„ Ø¹Ù…ÙŠÙ„ Ø¢Ø®Ø±ØŒ Ù‚Ù… Ø¨Ø§Ù„Ø¥Ù„ØºØ§Ø¡
            return; // undefined ÙŠØ¹Ù†ÙŠ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©
        });

        // ÙÙ‚Ø· Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„Ø°ÙŠ Ù†Ø¬Ø­ ÙÙŠ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© (committed = true) Ù‡Ùˆ Ù…Ù† Ø³ÙŠÙƒÙ…Ù„
        if (committed) {
            const winnerData = firebaseState.winnerInfo; // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙŠ Ø£Ø¯Øª Ø¥Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„ØªØ­Ø¯ÙŠØ«
            const startTime = firebaseState.gameStartTime || 0;
            const timeDiffSeconds = (winnerData.time - startTime) / 1000;
            const totalChars = (firebaseState.gameWords || []).join(" ").length;
            const wpm = timeDiffSeconds > 0 ? Math.round((totalChars / 5) / (timeDiffSeconds / 60)) : 0;

            // Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„ÙØ§Ø¦Ø² Ø¹Ø¨Ø± Ø§Ù„Ø¨ÙˆØª
            sendBotMessage(`ğŸ† Ø§Ù„ÙØ§Ø¦Ø² Ù‡Ùˆ ${winnerData.user} Ø¨Ø³Ø±Ø¹Ø© ${wpm} ÙƒÙ„Ù…Ø© ÙÙŠ Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø©!`);

            // Ø­Ø°Ù Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙØ§Ø¦Ø² ÙˆØ§Ù„ÙƒÙ„Ù…Ø§Øª Ø¨Ø¹Ø¯ Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„Ù†ØªÙŠØ¬Ø©
            await update(gameRef, { winnerInfo: null, gameWords: [] });
        }
    }
    
    if (localGameState.countdownActive && !localGameState.countdownMessagesSent) {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù‚Ø¯ ØªÙˆÙ„Ù‰ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø¨Ø§Ù„ÙØ¹Ù„ Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø¬ÙˆÙ„Ø©
        if (initiatedCountdownGameId !== localGameState.lastGameId) {
            initiatedCountdownGameId = localGameState.lastGameId; // ÙˆØ¶Ø¹ Ø¹Ù„Ø§Ù…Ø© Ù…Ø­Ù„ÙŠØ© ÙÙˆØ±Ù‹Ø§ Ù„Ù…Ù†Ø¹ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰

            // ğŸ’¡ Ù…Ø­Ø§ÙˆÙ„Ø© "Ù‚ÙÙ„" Ù…Ù‡Ù…Ø© Ø§Ù„ØªÙ†Ø³ÙŠÙ‚.
            // Ø³ÙŠÙ‚ÙˆÙ… Ø£ÙˆÙ„ Ø¹Ù…ÙŠÙ„ ÙŠÙ†Ø¬Ø­ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¨ØªÙˆÙ„ÙŠ Ø§Ù„Ù…Ù‡Ù…Ø©.
            // Ù†Ø³ØªØ®Ø¯Ù… onDisconnect Ù„Ø¶Ù…Ø§Ù† ØªØ­Ø±ÙŠØ± Ø§Ù„Ù‚ÙÙ„ Ø¥Ø°Ø§ Ø§Ù†Ù‚Ø·Ø¹ Ø§ØªØµØ§Ù„ Ø§Ù„Ù…Ù†Ø³Ù‚.
            const coordinatorRef = ref(db, 'game_state/coordinatorLock');
            await onDisconnect(coordinatorRef).remove(); // Ø¥Ø°Ø§ Ø§Ù†Ù‚Ø·Ø¹ Ø§ØªØµØ§Ù„ÙŠØŒ Ø­Ø±Ø± Ø§Ù„Ù‚ÙÙ„
            await set(coordinatorRef, userId); // Ù…Ø­Ø§ÙˆÙ„Ø© Ø£Ø®Ø° Ø§Ù„Ù‚ÙÙ„
            const lockHolder = (await get(coordinatorRef)).val();

            // ØªØ³Ù„Ø³Ù„ Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ
            await new Promise(resolve => setTimeout(resolve, 500));
            sendBotMessage("3...");
            await new Promise(resolve => setTimeout(resolve, 1000));
            sendBotMessage("2...");
            await new Promise(resolve => setTimeout(resolve, 1000));
            sendBotMessage("1...");
            await new Promise(resolve => setTimeout(resolve, 1000));

            // Ø¨Ø¹Ø¯ Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠØŒ Ø£Ø±Ø³Ù„ Ø§Ù„ÙƒÙ„Ù…Ø§Øª ÙˆØ­Ø¯Ø« Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© ÙÙŠ Firebase
            sendBotMessage(` ${localGameState.gameWords.join(" ")}`);
            const newGameStartTime = Date.now(); // ğŸ”¹ Ø§Ø³ØªØ®Ø¯Ø§Ù… Date.now() Ù„Ù„Ø¯Ù‚Ø©
            await set(gameRef, {
                ...localGameState, // Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø§Ù„Ø®ØµØ§Ø¦Øµ Ø§Ù„Ø£Ø®Ø±Ù‰
                countdownActive: false, // Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ
                inProgress: true,      // Ø§Ù„Ù„Ø¹Ø¨Ø© Ø§Ù„Ø¢Ù† Ù†Ø´Ø·Ø©
                gameStartTime: newGameStartTime // ğŸ”¹ Ø­ÙØ¸ ÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ø¯Ù‚ÙŠÙ‚
            }, { merge: true }); // Ø§Ø³ØªØ®Ø¯Ø§Ù… merge Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ù‚ÙÙ„
            await remove(coordinatorRef); // ØªØ­Ø±ÙŠØ± Ø§Ù„Ù‚ÙÙ„ Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ø¨Ù†Ø¬Ø§Ø­
            localGameState.gameStartTime = newGameStartTime; // ğŸ’¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ© ÙÙˆØ±Ù‹Ø§
        }
    } else if (!localGameState.inProgress && !localGameState.countdownActive) {
        // Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ø§Ù„Ù„Ø¹Ø¨Ø© Ù‚ÙŠØ¯ Ø§Ù„ØªÙ‚Ø¯Ù… ÙˆÙ„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ø¯ ØªÙ†Ø§Ø²Ù„ÙŠØŒ Ø£Ø¹Ø¯ ØªØ¹ÙŠÙŠÙ† Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ù…Ø¨Ø§Ø¯Ø±Ø©
        initiatedCountdownGameId = null;
    }
});

// ğŸŒªï¸ Ø¯Ø§Ù„Ø© Ù„Ø®Ù„Ø· ØªØ±ØªÙŠØ¨ Ø¹Ù†Ø§ØµØ± Ù…ØµÙÙˆÙØ© (Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ© Fisher-Yates)
function shuffleArray(array) {
    let currentIndex = array.length, randomIndex;
    // Ø¨ÙŠÙ†Ù…Ø§ Ù„Ø§ ÙŠØ²Ø§Ù„ Ù‡Ù†Ø§Ùƒ Ø¹Ù†Ø§ØµØ± Ù„Ø®Ù„Ø·Ù‡Ø§
    while (currentIndex !== 0) {
        // Ø§Ø®ØªØ± Ø¹Ù†ØµØ±Ù‹Ø§ Ù…ØªØ¨Ù‚ÙŠÙ‹Ø§
        randomIndex = Math.floor(Math.random() * currentIndex);
        currentIndex--;
        // ÙˆÙ‚Ù… Ø¨ØªØ¨Ø¯ÙŠÙ„Ù‡ Ù…Ø¹ Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ø­Ø§Ù„ÙŠ
        [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
    }
    return array;
}

// ğŸ”¹ Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙˆÙ…Ø¹Ø§Ù„Ø¬Ø© Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø¨ÙˆØª
async function handleMessageSend(text) {
    if(!text) return;

    // Ø£Ù…Ø± Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ (Ù„Ù„Ø£Ø¯Ù…Ù† ÙÙ‚Ø·)
    if(text.startsWith("/delete") && username === ADMIN_NAME){
        remove(messagesRef);
        return;
    }

    // ğŸ”„ Ø£Ù…Ø± "ÙŠÙ„Ø§" Ù„Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¬ÙˆÙ„Ø©
    if (text.trim() === "ÙŠÙ„Ø§") {
        const currentGameStateSnapshot = await get(gameRef);
        const currentGameState = currentGameStateSnapshot.val() || {};

        if (currentGameState.inProgress || currentGameState.countdownActive) {
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© ÙÙŠ Firebase
            await set(gameRef, {
                inProgress: false,
                countdownActive: false,
                gameWords: [],
                gameStartTime: 0,
                lastGameId: currentGameState.lastGameId,
                wordCount: currentGameState.wordCount,
                countdownMessagesSent: false, // ğŸ†• Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¹Ù„Ù… Ø¹Ù†Ø¯ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¬ÙˆÙ„Ø©
                winnerAnnounced: false // ğŸ†• Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¹Ù„Ù… Ø¹Ù†Ø¯ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¬ÙˆÙ„Ø©
            });
            sendBotMessage("ğŸ”„ ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¬ÙˆÙ„Ø©. ÙŠÙ…ÙƒÙ†ÙƒÙ… Ø§Ù„Ø¨Ø¯Ø¡ Ù…Ù† Ø¬Ø¯ÙŠØ¯ Ø¨Ø§Ù„Ø£Ù…Ø± 'Ø·Ø´'.");
        }
        // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… "ÙŠÙ„Ø§" Ø¥Ù„Ù‰ Ø§Ù„Ø´Ø§Øª ÙÙŠ ÙƒÙ„ Ø§Ù„Ø£Ø­ÙˆØ§Ù„
        push(messagesRef, { user: username, userId: userId, color: userColor, text, time: new Date().toLocaleTimeString(), timestamp: Date.now() });
        return; // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©
    }

    // ğŸ¤– Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø¨ÙˆØª "Ø·Ø´"
    if (text.startsWith("Ø·Ø´")) {
        const currentGameStateSnapshot = await get(gameRef); // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø£Ø­Ø¯Ø« Ø­Ø§Ù„Ø© Ù„Ù„Ø¹Ø¨Ø© Ù…Ù† Firebase
        const currentGameState = currentGameStateSnapshot.val() || {};

        // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù„Ø¹Ø¨Ø© Ø¬Ø§Ø±ÙŠØ© Ø¨Ø§Ù„ÙØ¹Ù„ Ø£Ùˆ Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ Ù†Ø´Ø·
        if (currentGameState.inProgress || currentGameState.countdownActive) {
            sendBotMessage("Ù„Ø¹Ø¨Ø© Ø³Ø±Ø¹Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø© Ø¬Ø§Ø±ÙŠØ© Ø¨Ø§Ù„ÙØ¹Ù„. Ø§Ù†ØªØ¸Ø± Ø­ØªÙ‰ ØªÙ†ØªÙ‡ÙŠ Ø§Ù„Ø¬ÙˆÙ„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©.");
            // Ù„Ø§ ÙŠØ²Ø§Ù„ ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… "Ø·Ø´" Ù„ÙŠØ±Ø§Ù‡Ø§ Ø§Ù„Ø¬Ù…ÙŠØ¹
            push(messagesRef, { user: username, userId: userId, color: userColor, text, time: new Date().toLocaleTimeString(), timestamp: Date.now() });
            return; // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø£Ù…Ø±
        }

        // Ø£Ù…Ø± "Ø·Ø´" Ù…Ø¹ Ø±Ù‚Ù… (Ù…Ø«Ø§Ù„: Ø·Ø´7) - Ù„Ø­ÙØ¸ Ø§Ù„ÙƒÙ„Ù…Ø§Øª
        if (text.match(/^Ø·Ø´(\d+)$/)) {
            const numberMatch = text.match(/^Ø·Ø´(\d+)$/);
            const count = parseInt(numberMatch[1], 10);
            if (count > 0 && count <= 50) { // ØªØ­Ø¯ÙŠØ¯ Ø­Ø¯ Ø£Ù‚ØµÙ‰ 50 ÙƒÙ„Ù…Ø©
                // ğŸ”¹ ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø¯ Ø§Ù„ÙƒÙ„Ù…Ø§Øª ÙÙŠ Firebase Ù…Ø¨Ø§Ø´Ø±Ø©
                await update(gameRef, { wordCount: count });
                sendBotMessage(`âœ… ØªÙ… Ø­ÙØ¸ ${count} ÙƒÙ„Ù…Ø§Øª Ù„Ù„Ø¬ÙˆÙ„Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©.`);
            } else {
                sendBotMessage(`âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ø¹Ø¯Ø¯ ØµØ­ÙŠØ­ Ø¨ÙŠÙ† 1 Ùˆ 50.`);
            }
            push(messagesRef, { user: username, userId: userId, color: userColor, text, time: new Date().toLocaleTimeString(), timestamp: Date.now() });
            return; // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©
        }
        // Ø£Ù…Ø± "Ø·Ø´" ÙÙ‚Ø· - Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©
        else if (text === "Ø·Ø´") {
            // ğŸ’¡ Ø¬Ù„Ø¨ Ø£Ø­Ø¯Ø« Ø¹Ø¯Ø¯ Ù„Ù„ÙƒÙ„Ù…Ø§Øª Ù…Ù† Firebase Ù…Ø¨Ø§Ø´Ø±Ø© Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø¯Ù‚Ø©
            const latestWordCount = (await get(ref(db, 'game_state/wordCount'))).val() || localGameState.wordCount;

            if (latestWordCount > 0) {
                // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… "Ø·Ø´" Ø£ÙˆÙ„Ø§Ù‹
                push(messagesRef, { user: username, userId: userId, color: userColor, text, time: new Date().toLocaleTimeString(), timestamp: Date.now() });

                // ğŸŒªï¸ Ø®Ù„Ø· Ø§Ù„ÙƒÙ„Ù…Ø§Øª ÙˆØ§Ø®ØªÙŠØ§Ø± Ù…Ø¬Ù…ÙˆØ¹Ø© Ø¹Ø´ÙˆØ§Ø¦ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø© Ù„ÙƒÙ„ Ø¬ÙˆÙ„Ø©
                const shuffledWords = shuffleArray([...BOT_WORDS_LIST]); // Ø®Ù„Ø· Ù†Ø³Ø®Ø© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø©
                const gameWordsForThisRound = shuffledWords.slice(0, latestWordCount); // ğŸ”¹ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø­Ø¯Ø« Ù…Ù† Firebase

                // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ ÙÙŠ Firebase Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ
                await set(gameRef, {
                    inProgress: false, // Ù„ÙŠØ³Øª Ù‚ÙŠØ¯ Ø§Ù„ØªÙ‚Ø¯Ù… Ø¨Ø¹Ø¯ØŒ Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ Ù†Ø´Ø·
                    countdownActive: true,
                    gameWords: gameWordsForThisRound, // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø¹Ø´ÙˆØ§Ø¦ÙŠØ© Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø¬ÙˆÙ„Ø©
                    gameStartTime: 0,
                    lastGameId: new Date().getTime(), // Ù…Ø¹Ø±Ù ÙØ±ÙŠØ¯ Ù„Ø¬ÙˆÙ„Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© Ù‡Ø°Ù‡
                    wordCount: latestWordCount, // Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø¹Ø¯Ø¯ Ø§Ù„ÙƒÙ„Ù…Ø§Øª
                    countdownMessagesSent: false, // ğŸ†• Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù„Ù… Ø®Ø§Ø·Ø¦ Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø¹Ø¯ ØªÙ†Ø§Ø²Ù„ÙŠ Ø¬Ø¯ÙŠØ¯
                    winnerAnnounced: false // ğŸ†• Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù„Ù… Ø®Ø§Ø·Ø¦ Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ù„Ø¹Ø¨Ø© Ø¬Ø¯ÙŠØ¯Ø©
                });
            } else {
                sendBotMessage(`âš ï¸ Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø¹Ø¯Ø¯ Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø¨Ø¹Ø¯. Ø§Ø³ØªØ®Ø¯Ù… Ø£Ù…Ø±Ø§Ù‹ Ù…Ø«Ù„ "Ø·Ø´5" Ø£ÙˆÙ„Ø§Ù‹.`);
                push(messagesRef, { user: username, userId: userId, color: userColor, text, time: new Date().toLocaleTimeString(), timestamp: Date.now() });
            return; // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©
        }
    }
}

    // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ø£Ù…Ø± "Ø·Ø´"ØŒ Ø£Ùˆ ØªÙ… Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø£Ù…Ø± ÙˆØ¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©ØŒ ÙÙ‡Ø°Ù‡ Ø±Ø³Ø§Ù„Ø© Ø¹Ø§Ø¯ÙŠØ©
    push(messagesRef, {
        user: username,
        userId: userId, // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø±Ø³Ø§Ù„ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¯Ø§Ø¦Ù…Ù‹Ø§
        color: userColor,
        text,
        time: new Date().toLocaleTimeString(),
        timestamp: Date.now()
    });
}

// ğŸ”¹ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø¨Ø³Ø±Ø¹Ø© Ù‚ØµÙˆÙ‰ (ØªÙ… ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… handleMessageSend)
form.addEventListener("submit", async e => {
  e.preventDefault();
  await handleMessageSend(msgInput.value.trim());
  msgInput.value = "";
  msgInput.focus(); // Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
  remove(ref(db,"typing/"+userId));
  if(audioEnabled) playBeep({freq:900, volume:0.7, duration:0.045});
});

// Ø¥Ø±Ø³Ø§Ù„ ÙÙˆØ±ÙŠ Ø¹Ù†Ø¯ Ø¶ØºØ· Enter (Ø¨Ø¯ÙˆÙ† Shift)
msgInput.addEventListener("keydown", async e => {
  if (e.key === "Enter" && !e.shiftKey) {
    e.preventDefault();
    await handleMessageSend(msgInput.value.trim());
    msgInput.value = "";
    msgInput.focus();
    remove(ref(db,"typing/"+userId));
    if(audioEnabled) playBeep({freq:900, volume:0.7, duration:0.045});
  }
});

// ğŸ”¹ Ø§Ù„ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø­ÙŠØ© Ù…Ø¹ Ù†Ù‚Ø§Ø· Ù…ØªØ­Ø±ÙƒØ©
let typingTimeout;
msgInput.addEventListener("input", ()=>{
  set(ref(db,"typing/"+userId),{name:username, ts:Date.now()});
  clearTimeout(typingTimeout);
  typingTimeout = setTimeout(()=>remove(ref(db,"typing/"+userId)),2500);
});

onValue(typingRef,snapshot=>{
  const typingUsers = snapshot.val() || {};
  currentTyping = {};
  const now = Date.now();
  Object.entries(typingUsers).forEach(([id,u])=>{
    if(u.name !== username && now - (u.ts||0) < 2500){
      currentTyping[id] = true;
    }
  });
  renderUsers(currentUsers, currentTyping);

  // Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø£Ø³ÙÙ„ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©
  const names = Object.entries(typingUsers)
    .filter(([id,u])=>u.name!==username && now-(u.ts||0)<2500)
    .map(([id,u])=>u.name);
  typingBox.textContent = names.length ? `${names.join(" Ùˆ ")} ${names.length>1?"ÙŠÙƒØªØ¨ÙˆÙ† Ø§Ù„Ø¢Ù†...":"ÙŠÙƒØªØ¨ Ø§Ù„Ø¢Ù†..."}` : "";
});
</script>

<style>
body {
  font-family: "Cairo", sans-serif;
  background: url("https://images.pexels.com/photos/33971618/pexels-photo-33971618.jpeg") no-repeat center center fixed;
  background-size: cover;
  color: #eee;
  margin: 0;
  padding: 0;
  text-align: center;
  display: flex;
  flex-direction: column;
  align-items: center;
  height: 100dvh;
}

/* ğŸ”¹ Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø´Ø§Øª */
.chat-container {
  width: 95%;
  max-width: 900px;
  margin-top: 20px;
}

/* ğŸ”¹ Ø¹Ù†ÙˆØ§Ù† */
h2 { 
  color: #f2f2f2;
  margin: 0 0 10px 0;
  font-size: 1.3em;
  text-shadow: 0 2px 4px rgba(0,0,0,0.3);
  position: relative;
  padding-bottom: 8px;
}

h2::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 25%;
  width: 50%;
  height: 2px;
  background: linear-gradient(to right, transparent, #7c68ee00, transparent);
  border-radius: 2px;
}

/* ğŸ”¹ ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø´Ø§Øª */
#chat {
  width: 100%;
  height: 400px;
  overflow-y: auto;
  padding: 10px;
  background: #222a5900;;
  border-radius: 10px;
  box-sizing: border-box;
  scrollbar-width: thin;
  scrollbar-color: #333 #111;
}

#chat::-webkit-scrollbar { width: 6px; }
#chat::-webkit-scrollbar-thumb {
  background-color: #333;
  border-radius: 3px;
}

/* ğŸ”¹ Ø§Ù„ÙÙ‚Ø§Ø¹Ø§Øª */
.message {
  display: flex;
  align-items: center;
  justify-content: flex-start;
  direction: rtl;
  background-color: #090c1d69;
  border-radius: 10px;
  padding: 5px 10px;
  margin: 3px 0;
  gap: 6px;
  color: #f1f1f1;
  font-size: 0.95em;
  line-height: 1.3;
  max-width: 70%;
  word-break: break-word;
  animation: fadeIn 0.25s ease-out;
  box-shadow: 0 0 6px rgba(0,0,0,0.3);
}

/* ğŸ¤– Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¨ÙˆØª */
.message.bot-message {
  background-color: #5c1118a8; /* Ø®Ù„ÙÙŠØ© Ù…Ø®ØªÙ„ÙØ© Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¨ÙˆØª */
  border-left: 3px solid var(--bot-color, #ff4757);
  direction: ltr; /* Ù„Ø¶Ù…Ø§Ù† Ø¸Ù‡ÙˆØ± Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© ÙŠØ³Ø§Ø±Ù‹Ø§ Ø¥Ø°Ø§ Ø£Ø¶ÙŠÙØª */
  justify-content: flex-start;
}

/* ğŸ”¹ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… */
.message strong {
  display: inline;
  color: #8ef2a2;
  font-weight: bold;
  font-size: 0.9em;
  margin-left: 3px;
}

/* ğŸ”¹ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… */
.message.my-message {
  margin-left: auto;
  background-color: #667e174d;
  text-align: right;
  flex-direction: row-reverse;
}

/* ğŸ”¹ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø´Ø®ØµÙŠØ© */
.avatar {
  width: 26px;
  height: 26px;
  border-radius: 50%;
  border: 1.5px solid #3cdf28;
  flex-shrink: 0;
}

/* ğŸ”¹ Ø´Ø±ÙŠØ· Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ */
form {
  width: 100%;
  display: flex;
  margin-top: 8px;
  padding: 6px;
  background: rgba(27, 30, 48, 0.8);
  border-radius: 8px;
}

input {
  flex: 1;
  padding: 8px;
  border-radius: 6px;
  border: none;
  font-size: 0.95em;
  background-color: #11143100;
  color: #f9f9f9;
  outline: none;
}

button {
  padding: 8px 16px;
  border: none;
  border-radius: 6px;
  background: #7c68ee00;
  color: #ffee04;
  font-weight: bold;
  cursor: pointer;
  transition: 0.2s;
}

button:hover {
  background: #6956d600;
}

/* ğŸ”¹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† */
#users {
  list-style: none;
  padding: 0;
  margin: 10px 0 5px 0;
  width: 95%;
  max-width: 900px;
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  justify-content: center;
}

#users li {
  background: #47474721;
  padding: 6px 12px;
  border-radius: 15px;
  font-size: 0.9em;
  transition: 0.15s;
}

/* ğŸš« Ø²Ø± Ø§Ù„Ø·Ø±Ø¯ */
.kick-button {
  background: none;
  border: none;
  color: #ff6b6b;
  cursor: pointer;
  font-size: 1.1em;
  padding: 0 5px;
  margin-right: 5px; /* Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ø§Ù„Ø²Ø± ÙˆØ§Ù„Ø§Ø³Ù… */
  opacity: 0.7;
  transition: opacity 0.2s;
}
.kick-button:disabled {
  opacity: 0.3;
  cursor: not-allowed;
}

.kick-button:hover {
  opacity: 1;
}

/* ğŸ”¹ ØµÙˆØ±Ø© Ø§Ù„Ø£ÙØ§ØªØ§Ø± ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªØµÙ„ÙŠÙ† */
.user-list-avatar {
  width: 20px;
  height: 20px;
  border-radius: 50%;
  margin-left: 5px; /* Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ø§Ù„ØµÙˆØ±Ø© ÙˆØ§Ù„Ø§Ø³Ù… */
}

#users li:hover {
  transform: translateY(-2px);
  background: #222;
}

/* ğŸ”¹ ØªØ£Ø«ÙŠØ± Ø§Ù„Ø¸Ù‡ÙˆØ± */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

/* ğŸ”¹ Ù„Ù„Ù‡Ø§ØªÙ */
@media screen and (max-width: 768px) {
  #chat {
    height: 250px;
    padding: 6px;
  }

  .message {
    font-size: 0.85em;
    padding: 4px 6px;
    border-radius: 8px;
    max-width: 80%;
  }

  .avatar {
    width: 22px;
    height: 22px;
  }

  input {
    font-size: 0.85em;
    padding: 6px;
  }

  button {
    padding: 7px 12px;
    font-size: 0.85em;
  }
}
</style>





</head>
<body>
<h5 style="margin-top:20px; margin-bottom:10px;">Ø§Ù„Ù…ØªØµÙ„ÙˆÙ† Ø§Ù„Ø¢Ù†:</h5>
<ul id="users"></ul>
<!-- ØªÙ… ÙˆØ¶Ø¹ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø´Ø§Øª Ø¯Ø§Ø®Ù„ Ø­Ø§ÙˆÙŠØ© Ø¬Ø¯ÙŠØ¯Ø© Ù„ØªÙ†Ø¸ÙŠÙ…Ù‡Ø§ -->
<div class="chat-container">
  <h2>ğŸ’¬chat</h2>
  <div id="chat"></div>
  <div id="typing"></div>
  <form id="chatForm">
    <input id="msg" placeholder=" " autocomplete="off" />
    <button>Ø¥Ø±Ø³Ø§Ù„</button>
  </form>
</div>
</body>
</html>
