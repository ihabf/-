
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>💬 دردشة مؤقتة</title>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
import { getDatabase, ref, push, set, remove, onValue, onChildAdded, onChildRemoved, onDisconnect, get, update } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";

// 🔹 إعداد Firebase
const firebaseConfig = {
  apiKey: "AIzaSyDzGM7Zy6JIrFJyDj7s5SjAd-l8rbCe9VE",
  authDomain: "kelta-gmae.firebaseapp.com",
  databaseURL: "https://kelta-gmae-default-rtdb.firebaseio.com",
  projectId: "kelta-gmae",
  storageBucket: "kelta-gmae.firebasestorage.app",
  messagingSenderId: "247464874751",
  appId: "1:247464874751:web:779a3120e6b422fdee72ca",
  measurementId: "G-6C8HGRKLHS"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const usersRef = ref(db, "users");
const messagesRef = ref(db, "messages");
const typingRef = ref(db, "typing");
const gameRef = ref(db, "game_state"); // 🏁 عقدة جديدة لحالة اللعبة
const savedUsersRef = ref(db, "savedUsers");
const kickSignalRef = ref(db, "kick_signals"); // 🚫 عقدة جديدة لإشارات الطرد

const ADMIN_NAME = "KeltA";

// 🤖 إعدادات البوت "بسام"
const BOT_NAME = "البوت بسام✔";
const BOT_COLOR = "#f30217"; // ✨ هذا هو اللون الذي سيظهر به اسم البوت (حالياً أحمر)
const BOT_AVATAR_COLOR = "red"; // لون مربع الأفاتار في قائمة المتصلين
const BOT_AVATAR_URL = "https://i.pinimg.com/736x/2a/0d/77/2a0d77e1bf6d19ab336921683544bb35.jpg"; // ✨ ضع رابط صورة البوت هنا
const BOT_WORDS_LIST = ["قلب","رمح","عشب","صندوق","حبل","اشارةمرور","ثعلب","يضحك","قنفذ","علم","بقرة","كلب","شبح","قنبلة","نعامة","سجق","ديك","قطايف","روبوت","عشب","بطة","يمشي","ابرة","ذئب","نافذة","فرشة","صحن","بطريق","ملك","سكر","برجايفل","مزرعة","ملفوف","روبيان","مكة","مندي","ثلج","ذبابة","طاولة","ميكانيكي","جدار","ايسكريم","سكين","ماعز","كرةسلة","بطاطا","ملك","اصبع","سروال","بصل","سلك","سائق","طماطم","كنافة","اذن","جوال","نمر","طاووس","ثور","خوخ","توصيلة","قمر","شارع","منسف","مانجو","دم","ماء","طيار","عود","باص","جزيرة","تاج","عصا","تمساح","قدم","بيض","حزين","فأس","هاتف","حوت","روبيان","ظفر","قفل","ساعة","عسل","جوزالهند","كنب","عصفور","فطر","قطه","مخدة","شاورما","توت","مسطرة","فراولة","هدهد","قرد","زهرة","ذرة","مكتب","دولاب","فيش","فشار","سماء","يسبح","فيل","تنين","شريط","ذهب","الارض","بروكلي","غيوم","شوكولاته","برجر","فلوس","وحيدالقرن","فانوس","سنجاب","ملعقة","ملعقة","خريطة","صرصور","منديل","كاتشب","مصاصة","دبقطبي","نيزك","رمان","شارع","عقرب","حمار","عصفور","تلفاز","حفرة","نار","حقيبة","طاوله","كرةقدم","درع","دب","بقلاوة","اناناس","سرير","زيتون","غوريلا","سلم","شاحنة","مسجد","عصا","بركان","قدم","قوس","شطرنج","تاج","عاملنظافة","غسالة","منشار","حوت","مسدس","باب","دمية","جاموس","عائلة","ليل","حذاء","زرافة","طابعة","نمل","دولاب","خيار","شوربة","ستارة","كيس","ريموت","دباسة","سلطعون","باذنجان","مزهرية","مخدة","سيف","مكتبة","ورقة","مكتب","فستان","مشمش","كوب","كشري","سلحفاة","حليب","مجرة","نسر","غواصة","خشب","نظارة","افوكادو","قارب","بيانو","ذرة","مسرح","شنب","اسنان","انف","مروحة","قهوة","فقمة","سرير","حديقة","بلياردو","ساعةرملية","نهر","قنفذ","فول","فلاشة","مصباح","لسان","سيارة","قلمرصاص","سمكة","كوكيز","طائرة","ضفدع","كاميرا","تمر","خشب","شراب","عين","كوالا","زر","بامية","ضبع","يبكي","غراب","خبز","مسمار","موية","نخلة","كرز","بيتزا","شوكة","دكتور","مرآة","مايك","طريق","مغني","غابة","جبل","هيكلعظمي","بحر","مظلة","كبة","لاعب","خس","ساعة","برجخليفة","جزر","وسادة","خيمة","خياط","سبانخ","رقص","دجاج","صيدلي","اطفائي","كبسة","كيبورد","طاولة","سجاده","محفظة","خنزير","كرة","عنب","شاشة","قاضي","ذئب","شجرة","شاي","نعال","نجوم","فراخ","فلفل","نحلة","شامبو","خفاش","كنز","قوسقزح","اصبع","اخطبوط","محاسب","كتاب","طباخ","برق","غزال","خاتم","عظم","فطيرة","دفتر","ببغاء","جمل","طريق","برتقال","حماروحشي","زبالة","الماس","كرة","غرفة","ستيك","حلاوة","نقانق","دودة","ملعب","كرةسلة","ممثل","زيت","كنبة","كتاب","مدرسة","الماس","الكعبة","يضحك","مكياج","بسكوت","سمبوسة","شاحن","جبن","شمام","مذيع","صحراء","فرشاة","حمام","بومة","سيف","ليل","موز","صبار","وحش","جاكيت","جوافة","بطارية","شمعة","ليمون","جوهرة","معدة","شاطئ","باندا","دونات","فراشة","ارنب","اسد","سفينة","عصير","نجوم","ولاعة","مكرونة","ثوب","سكين","قدر","تبولة","بطيخ","وسادة","ابرة","سوشي","صاروخ","جالس","سماعة","شرطي","مكيف","قطة","مقلوبة","مقص","دجاجمشوي","فأس","فرسالنهر","طبل","يركض","مكنسة","قلمرصاص","حاجب","اعصار","كوخ","شوكة","مطر","فهد","قبعة","ثعبان","رسام","غيوم","حمص","يد","عنكبوت","برياني","سحلية","لحم","وردة","مطعم","جرس","سبورة","بطن","قارورة","سينما","مهندس","عطر","ورقعنب","معلم","ممرضة","سلم","مطر","عصا","كريب","برق","قطار","كباب","طفل","شلال","يبكي","سلطة","سجادة","مشط","قبعة","خلاط","نوم","شتاء","حزين","ليل","ثلاجة","كهربائي","كأس","شاي","جامعة","برج","تفاح","عشب","بطه","جمجمة","كرسي","بطاطس","بسكوت","مكنسة","كيك","افوكادو","صابون","قمر","هرم","ساعةيد","كوكب","لابتوب","شنطة","عمارة","بيت","ديناصور","فرن","رز","مفتاح","رموش","جوارب","مدينة","قلم","سلة","حصان","زومبي","نجمة","علبة","مطبخ","فاصوليا","قهوة","كمبيوتر","ملوخية","قميص","مرحاض","فم","صقر","طاوله"]; // قائمة كلمات قابلة للتعديل
let savedBotWords = JSON.parse(localStorage.getItem("savedBotWords")) || [];

// 🏁 حالة اللعبة المحلية (تتم مزامنتها مع Firebase)
let localGameState = {
    inProgress: false,         // هل اللعبة جارية؟
    countdownActive: false,    // هل العد التنازلي نشط؟
    gameWords: [],             // الكلمات الحالية للعبة
    gameStartTime: 0,          // وقت بدء اللعبة الفعلي (بعد العد التنازلي)
    lastGameId: null,          // معرف فريد لكل جولة لعبة لمنع التكرار
    countdownMessagesSent: false, // 🆕 لتتبع ما إذا كانت رسائل العد التنازلي قد أُرسلت
    winnerAnnounced: false,    // 🆕 لتتبع ما إذا كان الفائز قد أُعلن
    wordCount: 5               // 🔹 عدد الكلمات المشترك للعبة، القيمة الافتراضية 5
};

// 🚩 متغير محلي لتتبع ما إذا كان هذا العميل قد بدأ العد التنازلي لجولة معينة
// هذا يضمن أن عميلًا واحدًا فقط يقوم بتشغيل العد التنازلي وإرسال الكلمات إلى Firebase
let initiatedCountdownGameId = null;

// 🔹 منع تعدد الجلسات (التبويبات)
const channel = new BroadcastChannel('chat_session_channel');
let isPrimaryTab = false;

window.addEventListener('load', () => {
    // إرسال إشعار بأن هذا التبويب موجود
    channel.postMessage('new_tab_opened');
});

channel.onmessage = (event) => {
    if (event.data === 'new_tab_opened' && !isPrimaryTab) {
        // تبويب آخر كان موجودًا قبلي، إذن هذا التبويب مكرر
        document.body.innerHTML = `<div style="text-align: center; padding: 50px; font-size: 1.5em; color: #ff6b6b;">
            <h1>🚫 جلسة مكررة</h1>
            <p>يمكن فتح الدردشة في تبويب واحد فقط في كل مرة.</p>
        </div>`;
        // إيقاف جميع الاتصالات والعمليات
        channel.close();
        throw new Error("Duplicate tab detected. Halting script execution.");
    }
};
isPrimaryTab = true; // هذا التبويب هو الأساسي

// 🔹 إنشاء معرف فريد للجهاز
let deviceId = localStorage.getItem("chat_device_id") || "dev_" + Math.floor(Math.random()*1e9);
localStorage.setItem("chat_device_id", deviceId);

// 🔹 اختيار اسم المستخدم
async function chooseUsername() {
  let username = localStorage.getItem("chat_username");
  const savedData = (await get(savedUsersRef)).val() || {};
  if(username && savedData[username]?.deviceId===deviceId) return username;

  let valid=false;
  while(!valid){
    username = prompt("اكتب اسمك:")?.trim();
    if(!username) continue;
    const usersData = (await get(usersRef)).val() || {};
    const nameTaken = Object.values(usersData).some(u=>u.name===username);
    const nameSavedElsewhere = savedData[username] && savedData[username].deviceId!==deviceId;
    if(nameTaken || nameSavedElsewhere) continue;
    valid=true;
  }
  localStorage.setItem("chat_username", username);
  return username;
}

const username = await chooseUsername();

// 🔹 اختيار اللون وحفظه
const colors = ["#ffadad","#ffd6a5","#fdffb6","#caffbf","#9bf6ff","#a0c4ff","#bdb2ff","#ffc6ff"];
const userColor = colors[Math.floor(Math.random()*colors.length)];
await set(ref(db, "savedUsers/"+username), {color:userColor, deviceId});

// 🔹 إنشاء المستخدم
// 🔹 استخدام userId من localStorage لمنع الاستنساخ عند التحديث
let userId = localStorage.getItem("chat_userId") || "user_" + Math.floor(Math.random() * 1e9);
localStorage.setItem("chat_userId", userId);
const userRef = ref(db, "users/"+userId);
function isMobileDevice() {
    return /Mobi|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
}
const deviceType = isMobileDevice() ? 'mobile' : 'desktop';

// 🔹 جلب IP المستخدم وتخزينه
let userIP = "N/A"; // قيمة افتراضية في حال فشل الجلب
try {
    const response = await fetch('https://api.ipify.org?format=json');
    const data = await response.json();
    userIP = data.ip;
} catch (error) {
    console.error("Failed to fetch IP address:", error);
}

// 🔹 دالة لإنشاء أو إعادة إنشاء المستخدم في قاعدة البيانات
async function registerUserPresence() {
    const userRecord = {
        name: username,
        color: userColor,
        online: true,
        lastSeen: Date.now(),
        device: deviceType,
        ip: userIP,
        deviceId: deviceId
    };
    // قم بإلغاء أي عمليات onDisconnect قديمة قبل تعيين واحدة جديدة
    await onDisconnect(userRef).cancel();
    // قم بتعيين بيانات المستخدم وأمر الحذف عند الانقطاع
    await set(userRef, userRecord);
    onDisconnect(userRef).remove();
}

// قم بتسجيل المستخدم عند التحميل الأولي
await registerUserPresence();
// قم بتحديث حالة "متصل" كل 5 ثوانٍ
setInterval(() => update(userRef, { online: true, lastSeen: Date.now() }), 5000);

// عناصر الصفحة
const chatBox=document.getElementById("chat");
const form=document.getElementById("chatForm");
const msgInput=document.getElementById("msg");
const typingBox=document.getElementById("typing");
const userList=document.getElementById("users");

// 🔹 صوت نقرة هادئة (مولد صوتي صغير عبر Web Audio)
let audioEnabled = false;
const AudioCtx = window.AudioContext || window.webkitAudioContext;
const audioCtx = new (AudioCtx)();
document.addEventListener('click', ()=>{
  audioEnabled = true;
  if(audioCtx.state === 'suspended') audioCtx.resume();
}, {once: true});

// مولد نقرة قصيرة هادئة (ضوضاء مشطوفة)
function playClickNoise({volume = 0.05, duration = 0.018} = {}){
  if(!audioEnabled) return;
  try{
    const sampleCount = Math.max(64, Math.floor(audioCtx.sampleRate * duration));
    const buffer = audioCtx.createBuffer(1, sampleCount, audioCtx.sampleRate);
    const data = buffer.getChannelData(0);
    for(let i=0;i<sampleCount;i++){
      const env = Math.exp(-6 * (i / sampleCount));
      data[i] = (Math.random() * 2 - 1) * env * 0.7;
    }
    const src = audioCtx.createBufferSource();
    src.buffer = buffer;
    const g = audioCtx.createGain();
    g.gain.value = volume;
    src.connect(g);
    g.connect(audioCtx.destination);
    src.start();
    src.stop(audioCtx.currentTime + duration + 0.01);
  }catch(e){ /* silent failure */ }
}

// مولد نغمة قصيرة (لتمييز الخروج)
function playBeep({freq = 700, volume = 0.04, duration = 0.06} = {}){
  if(!audioEnabled) return;
  try{
    const osc = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    osc.type = 'sine';
    osc.frequency.value = freq;
    g.gain.value = volume;
    // لفّ سريع للـ gain لإتقان النغمة
    g.gain.setValueAtTime(0.0001, audioCtx.currentTime);
    g.gain.exponentialRampToValueAtTime(volume, audioCtx.currentTime + 0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + duration);
    osc.connect(g);
    g.connect(audioCtx.destination);
    osc.start();
    osc.stop(audioCtx.currentTime + duration + 0.01);
  }catch(e){ /* silent failure */ }
}

// دوال مريحة للاستخدام في الانضمام/المغادرة
const playJoin = ()=> playClickNoise({volume:1, duration:0.018});
const playLeave = ()=> playBeep({freq:560, volume:1, duration:0.06});

// 🔹 عرض المستخدمين مع حالة الكتابة
function renderUsers(users, typingUsers){
  userList.innerHTML = "";

  // إضافة البوت "بسام" إلى قائمة المتصلين بشكل دائم
  const botLi = document.createElement("li");
  botLi.innerHTML = `<img src="${BOT_AVATAR_URL}" class="user-list-avatar"> ${BOT_NAME}`;
  botLi.style.borderRight = `6px solid ${BOT_AVATAR_COLOR}`;
  botLi.style.fontWeight = "bold";
  userList.appendChild(botLi);


  // إضافة المستخدمين الحقيقيين
  Object.entries(users).forEach(([id,u])=>{
    const li = document.createElement("li");
    let typingAnim = "";
    if(typingUsers[id]){
      typingAnim = `<span class="dots">…</span>`;
    }
    const deviceEmoji = u.device === 'mobile' ? '📱' : '💻';
    // 🔹 عرض IP للمدير فقط
    let userDetails = `${deviceEmoji} ${u.name} ${typingAnim}`;
    if (username === ADMIN_NAME && u.ip) {
        userDetails += ` <span style="color: #ffcc00; font-size: 0.8em;">(${u.ip})</span>`;
    }
    li.innerHTML = userDetails;
    li.style.borderRight = `6px solid ${u.color}`;

    // 🚫 إضافة زر الطرد للمدير فقط
    if (username === ADMIN_NAME && u.name !== ADMIN_NAME) {
        const kickButton = document.createElement("button");
        kickButton.textContent = "🚫";
        kickButton.className = "kick-button";

        // التحقق من وجود deviceId لتفعيل الزر
        if (u.deviceId) {
            kickButton.title = `طرد المستخدم ${u.name}`;
            kickButton.onclick = (e) => {
                e.stopPropagation(); // منع أي أحداث نقر أخرى
                if (confirm(`هل أنت متأكد من طرد ${u.name}؟`)) {
                    const signalId = "kick_" + Date.now();
                    set(ref(db, `kick_signals/${signalId}`), { targetDeviceId: u.deviceId });
                    setTimeout(() => remove(ref(db, `kick_signals/${signalId}`)), 5000);
                }
            };
        } else {
            // إذا لم يكن deviceId موجودًا، يتم تعطيل الزر
            kickButton.disabled = true;
            kickButton.title = `لا يمكن طرد ${u.name}، يحتاج لتحديث الصفحة.`;
        }
        li.appendChild(kickButton);
    }

    userList.appendChild(li);
  });
}

// 🔹 استقبال المستخدمين والكتابة الحية
let currentUsers = {};
let currentTyping = {};
onValue(usersRef, snapshot=>{
  currentUsers = snapshot.val() || {};
  renderUsers(currentUsers, currentTyping);
});

// 🔹 إشعار عند دخول وخروج المستخدمين
onChildAdded(usersRef, snapshot=>{
  const u = snapshot.val();
  if(u.name !== username){
    const div = document.createElement("div");
    div.className="message";
    div.style.fontStyle="italic";
    div.style.color="#55ff55";
    div.textContent = `✅ ${u.name} انضم إلى الغرفة`;
    chatBox.appendChild(div);
    chatBox.scrollTop = chatBox.scrollHeight;
    if(audioEnabled) playJoin();
  }
});
onChildRemoved(usersRef, snapshot=>{
  const u = snapshot.val();
  const div = document.createElement("div");
  div.className="message";
  div.style.fontStyle="italic";
  div.style.color="#ff5555";
  div.textContent = `❌ ${u.name} غادر الغرفة`;
  chatBox.appendChild(div);
  chatBox.scrollTop = chatBox.scrollHeight;
  if(audioEnabled) playBeep({freq:1200, volume:0.5, duration:0.04}); // صوت استلام رسالة
  if(audioEnabled) playLeave();
});

// 🔹 معالجة إعادة الاتصال بعد الانقطاع
onValue(ref(db, '.info/connected'), async (snapshot) => {
    if (snapshot.val() === true) {
        console.log("✅ تمت إعادة الاتصال بـ Firebase.");
        // تحقق مما إذا كان المستخدم لا يزال موجودًا، إذا لم يكن كذلك، أعد تسجيله
        const userSnapshot = await get(userRef);
        if (!userSnapshot.exists()) {
            console.log("⚠️ المستخدم غير موجود بعد إعادة الاتصال، سيتم إعادة تسجيله.");
            await registerUserPresence();
        }
    }
});

// 🚫 الاستماع لإشارات الطرد
onChildAdded(kickSignalRef, (snapshot) => {
    const signal = snapshot.val();
    // إذا كانت الإشارة تستهدف هذا الجهاز
    if (signal && signal.targetDeviceId === deviceId) {
        alert("لقد تم طردك من قبل المدير.");
        window.location.reload();
    }
});

// 🤖 دالة لإرسال رسالة من البوت
function sendBotMessage(text) {
  push(messagesRef, {
    user: BOT_NAME,
    color: BOT_COLOR,
    userId: "bot_id", // معرف خاص بالبوت
    text: text,
    time: new Date().toLocaleTimeString(), // للعرض
    timestamp: Date.now() // للطوابع الزمنية الدقيقة (لعبة السرعة)
  });
}

// 🔹 استقبال الرسائل الجديدة فقط بعد دخول المستخدم
let firstLoad = true;
onChildAdded(messagesRef, snapshot=>{
  // إذا كان هذا هو التحميل الأولي للصفحة، لا تعرض الرسائل القديمة.
  if (firstLoad) return;

  const m = snapshot.val();
  const messageKey = snapshot.key; // مفتاح الرسالة الفريد

  // 🤖 الرد على التحية
  // يتم التحقق فقط إذا كانت الرسالة ليست من البوت، والنص هو "السلام عليكم"، ولم يتم الرد عليها بعد
  if (m.userId !== "bot_id" && m.text.trim() === "السلام عليكم" && !m.replied) {
    // فقط العميل الذي أرسل الرسالة الأصلية هو من يرد
    if (m.userId === userId) {
      // تأخير بسيط لجعل الرد يبدو طبيعيًا
      setTimeout(() => {
          sendBotMessage(`وعليكم السلام يا ${m.user} منوووووووووووووووووووووووووووووووووووور 🥳🎉👋`);
      }, 500);
    }
    // وضع علامة على الرسالة الأصلية بأنه تم الرد عليها لمنع التكرار
    update(ref(db, `messages/${messageKey}`), { replied: true });
  }

  // 🏁 التحقق من الفائز في لعبة سرعة الكتابة
  // يتم التحقق فقط إذا كانت اللعبة قيد التقدم، الرسالة ليست من البوت، النص يطابق كلمات اللعبة، ووقت الرسالة بعد بدء اللعبة.
  if (localGameState.inProgress && m.userId !== "bot_id" && m.text.trim() === localGameState.gameWords.join(" ") && m.timestamp >= localGameState.gameStartTime) {
    // إنهاء اللعبة في Firebase أولاً لمنع إعلانات الفوز المتعددة
    // العميل الأول الذي ينجح في تحديث الحالة هو فقط من سيعلن الفائز
    // 💡 استخدام 'update' لتغيير فقط الخصائص الضرورية وعدم مسح 'gameWords' و 'gameStartTime'
    update(gameRef, {
        inProgress: false, // أهم خطوة: إيقاف اللعبة فورًا
        countdownActive: false,
        winnerInfo: { // إضافة معلومات الفائز
            user: m.user,
            time: m.timestamp
        }
    });
  }

  // 🔽 عرض الرسائل الجديدة فقط في الشات
  // إنشاء الحاوية
  const msgContainer = document.createElement("div");
  msgContainer.classList.add("message");

  // إضافة اسم المستخدم والرسالة
  const textDiv = document.createElement("div");
  let nameColor = "white"; // الافتراضي: كل المستخدمين باللون الأبيض
  let isAdmin = false;

  // إذا كان المستخدم هو المسؤول، غيّر اللون إلى ذهبي
  if (m.user === ADMIN_NAME) {
    nameColor = "gold";
    isAdmin = true;
  }

  // 🤖 إذا كانت الرسالة من البوت، استخدم لونه المحدد
  if (m.user === BOT_NAME) {
    nameColor = BOT_COLOR;
  }

  // أضف التاج بجانب اسم المسؤول فقط 👑
  textDiv.innerHTML = `
    <strong class="username" style="color:${nameColor}">
      ${m.user}${isAdmin ? " 👑" : ""}:
    </strong> ${m.text}
  `;

  msgContainer.appendChild(textDiv);

  // إذا كانت الرسالة من المستخدم الحالي، أضف فئة خاصة لمحاذاتها يمينًا
  if (m.user === username) {
    msgContainer.classList.add("my-message");
  }

  // 🤖 إذا كانت الرسالة من البوت، أضف فئة خاصة
  if (m.user === BOT_NAME) {
    msgContainer.classList.add("bot-message");
  }

  // 🔹 إضافة صورة رمزية لمستخدم واحد محدد (مثلاً المدير)
  if (m.user === ADMIN_NAME) { // ← غيّر الاسم كما تريد
    const avatar = document.createElement("img");
    avatar.src = "https://i.pinimg.com/1200x/21/3d/f8/213df8f9bc8e0189d0b494a9b195e308.jpg"; // ضع رابط الصورة الرمزية هنا
    avatar.classList.add("avatar");
    msgContainer.appendChild(avatar);
  }

  // 🤖 إضافة صورة رمزية للبوت
  if (m.user === BOT_NAME) {
    const avatar = document.createElement("img");
    avatar.src = BOT_AVATAR_URL;
    avatar.classList.add("avatar");
    msgContainer.appendChild(avatar);
  }

  chatBox.appendChild(msgContainer);
  chatBox.scrollTop = chatBox.scrollHeight;
});

get(messagesRef).then(()=>{ firstLoad=false; });

// 🔹 تحديث فوري عند حذف الرسائل
onValue(messagesRef, snapshot => {
  if(!snapshot.exists()){
    chatBox.innerHTML = "";
  }
});

// 🏁 Listener لحالة اللعبة من Firebase
onValue(gameRef, async (snapshot) => {
    const firebaseState = snapshot.val() || {};

    // تحديث الحالة المحلية للعبة بناءً على Firebase
    localGameState = {
        inProgress: firebaseState.inProgress || false,
        countdownActive: firebaseState.countdownActive || false,
        gameWords: firebaseState.gameWords || [],
        gameStartTime: firebaseState.gameStartTime || 0,
        lastGameId: firebaseState.lastGameId || null,
        wordCount: firebaseState.wordCount || 5, // 🔹 قراءة عدد الكلمات من Firebase
        countdownMessagesSent: firebaseState.countdownMessagesSent || false, // 🆕 تحديث الحالة المحلية
        winnerAnnounced: firebaseState.winnerAnnounced || false // 🆕 تحديث الحالة المحلية
    };

    // 🤖 محاكاة البوت كمنسق: أول عميل يرى العد التنازلي نشطًا يتولى المهمة
    if (localGameState.countdownActive && !localGameState.countdownMessagesSent) {
        // ... (The countdown logic remains here)
    }

    // 🏆 التحقق من وجود فائز لإعلان النتيجة مرة واحدة فقط
    // يتم هذا التحقق عند تغير حالة اللعبة إلى "غير جارية" ووجود معلومات الفائز
    if (!firebaseState.inProgress && firebaseState.winnerInfo && !firebaseState.winnerAnnounced) {
        // 💡 محاولة "حجز" مهمة إعلان الفائز باستخدام معاملة ذرية
        // هذا يضمن أن عميلًا واحدًا فقط سينجح في هذا التحديث
        const { committed, snapshot } = await runTransaction(gameRef, (currentData) => {
            if (currentData && !currentData.winnerAnnounced && currentData.winnerInfo) {
                // إذا لم يتم إعلان الفائز بعد، قم بتحديث الحالة
                currentData.winnerAnnounced = true;
                return currentData; // إرجاع البيانات المحدثة لحفظها
            }
            // إذا تم إعلان الفائز بالفعل من قبل عميل آخر، قم بالإلغاء
            return; // undefined يعني إلغاء المعاملة
        });

        // فقط العميل الذي نجح في المعاملة (committed = true) هو من سيكمل
        if (committed) {
            const winnerData = firebaseState.winnerInfo; // استخدام البيانات التي أدت إلى هذا التحديث
            const startTime = firebaseState.gameStartTime || 0;
            const timeDiffSeconds = (winnerData.time - startTime) / 1000;
            const totalChars = (firebaseState.gameWords || []).join(" ").length;
            const wpm = timeDiffSeconds > 0 ? Math.round((totalChars / 5) / (timeDiffSeconds / 60)) : 0;

            // إعلان الفائز عبر البوت
            sendBotMessage(`🏆 الفائز هو ${winnerData.user} بسرعة ${wpm} كلمة في الدقيقة!`);

            // حذف معلومات الفائز والكلمات بعد إعلان النتيجة
            await update(gameRef, { winnerInfo: null, gameWords: [] });
        }
    }
    
    if (localGameState.countdownActive && !localGameState.countdownMessagesSent) {
        // التحقق مما إذا كان هذا العميل قد تولى التنسيق بالفعل لهذه الجولة
        if (initiatedCountdownGameId !== localGameState.lastGameId) {
            initiatedCountdownGameId = localGameState.lastGameId; // وضع علامة محلية فورًا لمنع المحاولة مرة أخرى

            // 💡 محاولة "قفل" مهمة التنسيق.
            // سيقوم أول عميل ينجح في هذا التحديث بتولي المهمة.
            // نستخدم onDisconnect لضمان تحرير القفل إذا انقطع اتصال المنسق.
            const coordinatorRef = ref(db, 'game_state/coordinatorLock');
            await onDisconnect(coordinatorRef).remove(); // إذا انقطع اتصالي، حرر القفل
            await set(coordinatorRef, userId); // محاولة أخذ القفل
            const lockHolder = (await get(coordinatorRef)).val();

            // تسلسل العد التنازلي
            await new Promise(resolve => setTimeout(resolve, 500));
            sendBotMessage("3...");
            await new Promise(resolve => setTimeout(resolve, 1000));
            sendBotMessage("2...");
            await new Promise(resolve => setTimeout(resolve, 1000));
            sendBotMessage("1...");
            await new Promise(resolve => setTimeout(resolve, 1000));

            // بعد العد التنازلي، أرسل الكلمات وحدث حالة اللعبة في Firebase
            sendBotMessage(` ${localGameState.gameWords.join(" ")}`);
            const newGameStartTime = Date.now(); // 🔹 استخدام Date.now() للدقة
            await set(gameRef, {
                ...localGameState, // الاحتفاظ بالخصائص الأخرى
                countdownActive: false, // انتهاء العد التنازلي
                inProgress: true,      // اللعبة الآن نشطة
                gameStartTime: newGameStartTime // 🔹 حفظ وقت البدء الدقيق
            }, { merge: true }); // استخدام merge للحفاظ على القفل
            await remove(coordinatorRef); // تحرير القفل بعد الانتهاء بنجاح
            localGameState.gameStartTime = newGameStartTime; // 💡 تحديث الحالة المحلية فورًا
        }
    } else if (!localGameState.inProgress && !localGameState.countdownActive) {
        // إذا لم تكن اللعبة قيد التقدم ولا يوجد عد تنازلي، أعد تعيين علامة المبادرة
        initiatedCountdownGameId = null;
    }
});

// 🌪️ دالة لخلط ترتيب عناصر مصفوفة (خوارزمية Fisher-Yates)
function shuffleArray(array) {
    let currentIndex = array.length, randomIndex;
    // بينما لا يزال هناك عناصر لخلطها
    while (currentIndex !== 0) {
        // اختر عنصرًا متبقيًا
        randomIndex = Math.floor(Math.random() * currentIndex);
        currentIndex--;
        // وقم بتبديله مع العنصر الحالي
        [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
    }
    return array;
}

// 🔹 دالة مساعدة لإرسال الرسائل ومعالجة أوامر البوت
async function handleMessageSend(text) {
    if(!text) return;

    // أمر حذف الرسائل (للأدمن فقط)
    if(text.startsWith("/delete") && username === ADMIN_NAME){
        remove(messagesRef);
        return;
    }

    // 🔄 أمر "يلا" لإعادة تعيين الجولة
    if (text.trim() === "يلا") {
        const currentGameStateSnapshot = await get(gameRef);
        const currentGameState = currentGameStateSnapshot.val() || {};

        if (currentGameState.inProgress || currentGameState.countdownActive) {
            // إعادة تعيين حالة اللعبة في Firebase
            await set(gameRef, {
                inProgress: false,
                countdownActive: false,
                gameWords: [],
                gameStartTime: 0,
                lastGameId: currentGameState.lastGameId,
                wordCount: currentGameState.wordCount,
                countdownMessagesSent: false, // 🆕 إعادة تعيين العلم عند إعادة الجولة
                winnerAnnounced: false // 🆕 إعادة تعيين العلم عند إعادة الجولة
            });
            sendBotMessage("🔄 تم إعادة تعيين الجولة. يمكنكم البدء من جديد بالأمر 'طش'.");
        }
        // إرسال رسالة المستخدم "يلا" إلى الشات في كل الأحوال
        push(messagesRef, { user: username, userId: userId, color: userColor, text, time: new Date().toLocaleTimeString(), timestamp: Date.now() });
        return; // إيقاف المزيد من المعالجة
    }

    // 🤖 معالجة أوامر البوت "طش"
    if (text.startsWith("طش")) {
        const currentGameStateSnapshot = await get(gameRef); // الحصول على أحدث حالة للعبة من Firebase
        const currentGameState = currentGameStateSnapshot.val() || {};

        // إذا كانت اللعبة جارية بالفعل أو العد التنازلي نشط
        if (currentGameState.inProgress || currentGameState.countdownActive) {
            sendBotMessage("لعبة سرعة الكتابة جارية بالفعل. انتظر حتى تنتهي الجولة الحالية.");
            // لا يزال يتم إرسال رسالة المستخدم "طش" ليراها الجميع
            push(messagesRef, { user: username, userId: userId, color: userColor, text, time: new Date().toLocaleTimeString(), timestamp: Date.now() });
            return; // إيقاف المزيد من المعالجة لهذا الأمر
        }

        // أمر "طش" مع رقم (مثال: طش7) - لحفظ الكلمات
        if (text.match(/^طش(\d+)$/)) {
            const numberMatch = text.match(/^طش(\d+)$/);
            const count = parseInt(numberMatch[1], 10);
            if (count > 0 && count <= 50) { // تحديد حد أقصى 50 كلمة
                // 🔹 تحديث عدد الكلمات في Firebase مباشرة
                await update(gameRef, { wordCount: count });
                sendBotMessage(`✅ تم حفظ ${count} كلمات للجولة القادمة.`);
            } else {
                sendBotMessage(`⚠️ يرجى تحديد عدد صحيح بين 1 و 50.`);
            }
            push(messagesRef, { user: username, userId: userId, color: userColor, text, time: new Date().toLocaleTimeString(), timestamp: Date.now() });
            return; // إيقاف المزيد من المعالجة
        }
        // أمر "طش" فقط - لبدء اللعبة
        else if (text === "طش") {
            // 💡 جلب أحدث عدد للكلمات من Firebase مباشرة لضمان الدقة
            const latestWordCount = (await get(ref(db, 'game_state/wordCount'))).val() || localGameState.wordCount;

            if (latestWordCount > 0) {
                // إرسال رسالة المستخدم "طش" أولاً
                push(messagesRef, { user: username, userId: userId, color: userColor, text, time: new Date().toLocaleTimeString(), timestamp: Date.now() });

                // 🌪️ خلط الكلمات واختيار مجموعة عشوائية جديدة لكل جولة
                const shuffledWords = shuffleArray([...BOT_WORDS_LIST]); // خلط نسخة من القائمة الكاملة
                const gameWordsForThisRound = shuffledWords.slice(0, latestWordCount); // 🔹 استخدام العدد المحدث من Firebase

                // تحديث حالة اللعبة بالكامل في Firebase لبدء العد التنازلي
                await set(gameRef, {
                    inProgress: false, // ليست قيد التقدم بعد، العد التنازلي نشط
                    countdownActive: true,
                    gameWords: gameWordsForThisRound, // استخدام الكلمات العشوائية لهذه الجولة
                    gameStartTime: 0,
                    lastGameId: new Date().getTime(), // معرف فريد لجولة اللعبة هذه
                    wordCount: latestWordCount, // الحفاظ على عدد الكلمات
                    countdownMessagesSent: false, // 🆕 التأكد من أن هذا العلم خاطئ عند بدء عد تنازلي جديد
                    winnerAnnounced: false // 🆕 التأكد من أن هذا العلم خاطئ عند بدء لعبة جديدة
                });
            } else {
                sendBotMessage(`⚠️ لم يتم تحديد عدد الكلمات بعد. استخدم أمراً مثل "طش5" أولاً.`);
                push(messagesRef, { user: username, userId: userId, color: userColor, text, time: new Date().toLocaleTimeString(), timestamp: Date.now() });
            return; // إيقاف المزيد من المعالجة
        }
    }
}

    // إذا لم يكن أمر "طش"، أو تم التعامل مع الأمر وإيقاف المعالجة، فهذه رسالة عادية
    push(messagesRef, {
        user: username,
        userId: userId, // التأكد من إرسال معرف المستخدم دائمًا
        color: userColor,
        text,
        time: new Date().toLocaleTimeString(),
        timestamp: Date.now()
    });
}

// 🔹 إرسال الرسائل بسرعة قصوى (تم تعديلها لاستخدام handleMessageSend)
form.addEventListener("submit", async e => {
  e.preventDefault();
  await handleMessageSend(msgInput.value.trim());
  msgInput.value = "";
  msgInput.focus(); // للحفاظ على التركيز بعد الإرسال
  remove(ref(db,"typing/"+userId));
  if(audioEnabled) playBeep({freq:900, volume:0.7, duration:0.045});
});

// إرسال فوري عند ضغط Enter (بدون Shift)
msgInput.addEventListener("keydown", async e => {
  if (e.key === "Enter" && !e.shiftKey) {
    e.preventDefault();
    await handleMessageSend(msgInput.value.trim());
    msgInput.value = "";
    msgInput.focus();
    remove(ref(db,"typing/"+userId));
    if(audioEnabled) playBeep({freq:900, volume:0.7, duration:0.045});
  }
});

// 🔹 الكتابة الحية مع نقاط متحركة
let typingTimeout;
msgInput.addEventListener("input", ()=>{
  set(ref(db,"typing/"+userId),{name:username, ts:Date.now()});
  clearTimeout(typingTimeout);
  typingTimeout = setTimeout(()=>remove(ref(db,"typing/"+userId)),2500);
});

onValue(typingRef,snapshot=>{
  const typingUsers = snapshot.val() || {};
  currentTyping = {};
  const now = Date.now();
  Object.entries(typingUsers).forEach(([id,u])=>{
    if(u.name !== username && now - (u.ts||0) < 2500){
      currentTyping[id] = true;
    }
  });
  renderUsers(currentUsers, currentTyping);

  // الرسالة أسفل الدردشة
  const names = Object.entries(typingUsers)
    .filter(([id,u])=>u.name!==username && now-(u.ts||0)<2500)
    .map(([id,u])=>u.name);
  typingBox.textContent = names.length ? `${names.join(" و ")} ${names.length>1?"يكتبون الآن...":"يكتب الآن..."}` : "";
});
</script>

<style>
body {
  font-family: "Cairo", sans-serif;
  background: url("https://images.pexels.com/photos/33971618/pexels-photo-33971618.jpeg") no-repeat center center fixed;
  background-size: cover;
  color: #eee;
  margin: 0;
  padding: 0;
  text-align: center;
  display: flex;
  flex-direction: column;
  align-items: center;
  height: 100dvh;
}

/* 🔹 حاوية الشات */
.chat-container {
  width: 95%;
  max-width: 900px;
  margin-top: 20px;
}

/* 🔹 عنوان */
h2 { 
  color: #f2f2f2;
  margin: 0 0 10px 0;
  font-size: 1.3em;
  text-shadow: 0 2px 4px rgba(0,0,0,0.3);
  position: relative;
  padding-bottom: 8px;
}

h2::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 25%;
  width: 50%;
  height: 2px;
  background: linear-gradient(to right, transparent, #7c68ee00, transparent);
  border-radius: 2px;
}

/* 🔹 صندوق الشات */
#chat {
  width: 100%;
  height: 400px;
  overflow-y: auto;
  padding: 10px;
  background: #222a5900;;
  border-radius: 10px;
  box-sizing: border-box;
  scrollbar-width: thin;
  scrollbar-color: #333 #111;
}

#chat::-webkit-scrollbar { width: 6px; }
#chat::-webkit-scrollbar-thumb {
  background-color: #333;
  border-radius: 3px;
}

/* 🔹 الفقاعات */
.message {
  display: flex;
  align-items: center;
  justify-content: flex-start;
  direction: rtl;
  background-color: #090c1d69;
  border-radius: 10px;
  padding: 5px 10px;
  margin: 3px 0;
  gap: 6px;
  color: #f1f1f1;
  font-size: 0.95em;
  line-height: 1.3;
  max-width: 70%;
  word-break: break-word;
  animation: fadeIn 0.25s ease-out;
  box-shadow: 0 0 6px rgba(0,0,0,0.3);
}

/* 🤖 رسائل البوت */
.message.bot-message {
  background-color: #5c1118a8; /* خلفية مختلفة لرسائل البوت */
  border-left: 3px solid var(--bot-color, #ff4757);
  direction: ltr; /* لضمان ظهور الأيقونة يسارًا إذا أضيفت */
  justify-content: flex-start;
}

/* 🔹 اسم المستخدم */
.message strong {
  display: inline;
  color: #8ef2a2;
  font-weight: bold;
  font-size: 0.9em;
  margin-left: 3px;
}

/* 🔹 رسائل المستخدم */
.message.my-message {
  margin-left: auto;
  background-color: #667e174d;
  text-align: right;
  flex-direction: row-reverse;
}

/* 🔹 الصورة الشخصية */
.avatar {
  width: 26px;
  height: 26px;
  border-radius: 50%;
  border: 1.5px solid #3cdf28;
  flex-shrink: 0;
}

/* 🔹 شريط الإدخال */
form {
  width: 100%;
  display: flex;
  margin-top: 8px;
  padding: 6px;
  background: rgba(27, 30, 48, 0.8);
  border-radius: 8px;
}

input {
  flex: 1;
  padding: 8px;
  border-radius: 6px;
  border: none;
  font-size: 0.95em;
  background-color: #11143100;
  color: #f9f9f9;
  outline: none;
}

button {
  padding: 8px 16px;
  border: none;
  border-radius: 6px;
  background: #7c68ee00;
  color: #ffee04;
  font-weight: bold;
  cursor: pointer;
  transition: 0.2s;
}

button:hover {
  background: #6956d600;
}

/* 🔹 قائمة المستخدمين */
#users {
  list-style: none;
  padding: 0;
  margin: 10px 0 5px 0;
  width: 95%;
  max-width: 900px;
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  justify-content: center;
}

#users li {
  background: #47474721;
  padding: 6px 12px;
  border-radius: 15px;
  font-size: 0.9em;
  transition: 0.15s;
}

/* 🚫 زر الطرد */
.kick-button {
  background: none;
  border: none;
  color: #ff6b6b;
  cursor: pointer;
  font-size: 1.1em;
  padding: 0 5px;
  margin-right: 5px; /* مسافة بين الزر والاسم */
  opacity: 0.7;
  transition: opacity 0.2s;
}
.kick-button:disabled {
  opacity: 0.3;
  cursor: not-allowed;
}

.kick-button:hover {
  opacity: 1;
}

/* 🔹 صورة الأفاتار في قائمة المتصلين */
.user-list-avatar {
  width: 20px;
  height: 20px;
  border-radius: 50%;
  margin-left: 5px; /* مسافة بين الصورة والاسم */
}

#users li:hover {
  transform: translateY(-2px);
  background: #222;
}

/* 🔹 تأثير الظهور */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

/* 🔹 للهاتف */
@media screen and (max-width: 768px) {
  #chat {
    height: 250px;
    padding: 6px;
  }

  .message {
    font-size: 0.85em;
    padding: 4px 6px;
    border-radius: 8px;
    max-width: 80%;
  }

  .avatar {
    width: 22px;
    height: 22px;
  }

  input {
    font-size: 0.85em;
    padding: 6px;
  }

  button {
    padding: 7px 12px;
    font-size: 0.85em;
  }
}
</style>





</head>
<body>
<h5 style="margin-top:20px; margin-bottom:10px;">المتصلون الآن:</h5>
<ul id="users"></ul>
<!-- تم وضع عناصر الشات داخل حاوية جديدة لتنظيمها -->
<div class="chat-container">
  <h2>💬chat</h2>
  <div id="chat"></div>
  <div id="typing"></div>
  <form id="chatForm">
    <input id="msg" placeholder=" " autocomplete="off" />
    <button>إرسال</button>
  </form>
</div>
</body>
</html>
