<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>💬 دردشة مؤقتة</title>
<!-- مكتبة SHA256 للتعامل مع التشفير من جانب العميل للتحقق من الحظر -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/js-sha256/0.9.0/sha256.min.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
import { getDatabase, ref, push, set, remove, onValue, onChildAdded, onChildRemoved, onDisconnect, get, update } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";
import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-functions.js";

// 🔹 إعداد Firebase
const firebaseConfig = {
  apiKey: "AIzaSyDzGM7Zy6JIrFJyDj7s5SjAd-l8rbCe9VE",
  // ... (باقي إعدادات Firebase)
  authDomain: "kelta-gmae.firebaseapp.com",
  databaseURL: "https://kelta-gmae-default-rtdb.firebaseio.com",
  projectId: "kelta-gmae",
  storageBucket: "kelta-gmae.firebasestorage.app",
  messagingSenderId: "247464874751",
  appId: "1:247464874751:web:779a3120e6b422fdee72ca",
  measurementId: "G-6C8HGRKLHS"
  // ...
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const functions = getFunctions(app);

const usersRef = ref(db, "users");
const messagesRef = ref(db, "messages");
const typingRef = ref(db, "typing");
const gameRef = ref(db, "game_state"); // 🏁 عقدة جديدة لحالة اللعبة
const kickedUsersRef = ref(db, "kickedUsers"); // 🚫 عقدة للمستخدمين المطرودين
const bannedIPsRef = ref(db, "bannedIPs"); // 🚫 عقدة للـ IPs المحظورة
const savedUsersRef = ref(db, "savedUsers");

const ADMIN_NAME = "KeltA";

// 🤖 إعدادات البوت "بسام"
const BOT_NAME = "البوت بسام✔";
const BOT_COLOR = "#f30217"; // ✨ هذا هو اللون الذي سيظهر به اسم البوت (حالياً أحمر)
const BOT_AVATAR_COLOR = "red"; // لون مربع الأفاتار في قائمة المتصلين
const BOT_AVATAR_URL = "https://i.pinimg.com/736x/2a/0d/77/2a0d77e1bf6d19ab336921683544bb35.jpg"; // ✨ ضع رابط صورة البوت هنا
const BOT_WORDS_LIST = ["قلب","رمح","عشب","صندوق","حبل","اشارةمرور","ثعلب","يضحك","قنفذ","علم","بقرة","كلب","شبح","قنبلة","نعامة","سجق","ديك","قطايف","روبوت","عشب","بطة","يمشي","ابرة","ذئب","نافذة","فرشة","صحن","بطريق","ملك","سكر","برجايفل","مزرعة","ملفوف","روبيان","مكة","مندي","ثلج","ذبابة","طاولة","ميكانيكي","جدار","ايسكريم","سكين","ماعز","كرةسلة","بطاطا","ملك","اصبع","سروال","بصل","سلك","سائق","طماطم","كنافة","اذن","جوال","نمر","طاووس","ثور","خوخ","توصيلة","قمر","شارع","منسف","مانجو","دم","ماء","طيار","عود","باص","جزيرة","تاج","عصا","تمساح","قدم","بيض","حزين","فأس","هاتف","حوت","روبيان","ظفر","قفل","ساعة","عسل","جوزالهند","كنب","عصفور","فطر","قطه","مخدة","شاورما","توت","مسطرة","فراولة","هدهد","قرد","زهرة","ذرة","مكتب","دولاب","فيش","فشار","سماء","يسبح","فيل","تنين","شريط","ذهب","الارض","بروكلي","غيوم","شوكولاته","برجر","فلوس","وحيدالقرن","فانوس","سنجاب","ملعقة","ملعقة","خريطة","صرصور","منديل","كاتشب","مصاصة","دبقطبي","نيزك","رمان","شارع","عقرب","حمار","عصفور","تلفاز","حفرة","نار","حقيبة","طاوله","كرةقدم","درع","دب","بقلاوة","اناناس","سرير","زيتون","غوريلا","سلم","شاحنة","مسجد","عصا","بركان","قدم","قوس","شطرنج","تاج","عاملنظافة","غسالة","منشار","حوت","مسدس","باب","دمية","جاموس","عائلة","ليل","حذاء","زرافة","طابعة","نمل","دولاب","خيار","شوربة","ستارة","كيس","ريموت","دباسة","سلطعون","باذنجان","مزهرية","مخدة","سيف","مكتبة","ورقة","مكتب","فستان","مشمش","كوب","كشري","سلحفاة","حليب","مجرة","نسر","غواصة","خشب","نظارة","افوكادو","قارب","بيانو","ذرة","مسرح","شنب","اسنان","انف","مروحة","قهوة","فقمة","سرير","حديقة","بلياردو","ساعةرملية","نهر","قنفذ","فول","فلاشة","مصباح","لسان","سيارة","قلمرصاص","سمكة","كوكيز","طائرة","ضفدع","كاميرا","تمر","خشب","شراب","عين","كوالا","زر","بامية","ضبع","يبكي","غراب","خبز","مسمار","موية","نخلة","كرز","بيتزا","شوكة","دكتور","مرآة","مايك","طريق","مغني","غابة","جبل","هيكلعظمي","بحر","مظلة","كبة","لاعب","خس","ساعة","برجخليفة","جزر","وسادة","خيمة","خياط","سبانخ","رقص","دجاج","صيدلي","اطفائي","كبسة","كيبورد","طاولة","سجاده","محفظة","خنزير","كرة","عنب","شاشة","قاضي","ذئب","شجرة","شاي","نعال","نجوم","فراخ","فلفل","نحلة","شامبو","خفاش","كنز","قوسقزح","اصبع","اخطبوط","محاسب","كتاب","طباخ","برق","غزال","خاتم","عظم","فطيرة","دفتر","ببغاء","جمل","طريق","برتقال","حماروحشي","زبالة","الماس","كرة","غرفة","ستيك","حلاوة","نقانق","دودة","ملعب","كرةسلة","ممثل","زيت","كنبة","كتاب","مدرسة","الماس","الكعبة","يضحك","مكياج","بسكوت","سمبوسة","شاحن","جبن","شمام","مذيع","صحراء","فرشاة","حمام","بومة","سيف","ليل","موز","صبار","وحش","جاكيت","جوافة","بطارية","شمعة","ليمون","جوهرة","معدة","شاطئ","باندا","دونات","فراشة","ارنب","اسد","سفينة","عصير","نجوم","ولاعة","مكرونة","ثوب","سكين","قدر","تبولة","بطيخ","وسادة","ابرة","سوشي","صاروخ","جالس","سماعة","شرطي","مكيف","قطة","مقلوبة","مقص","دجاجمشوي","فأس","فرسالنهر","طبل","يركض","مكنسة","قلمرصاص","حاجب","اعصار","كوخ","شوكة","مطر","فهد","قبعة","ثعبان","رسام","غيوم","حمص","يد","عنكبوت","برياني","سحلية","لحم","وردة","مطعم","جرس","سبورة","بطن","قارورة","سينما","مهندس","عطر","ورقعنب","معلم","ممرضة","سلم","مطر","عصا","كريب","برق","قطار","كباب","طفل","شلال","يبكي","سلطة","سجادة","مشط","قبعة","خلاط","نوم","شتاء","حزين","ليل","ثلاجة","كهربائي","كأس","شاي","جامعة","برج","تفاح","عشب","بطه","جمجمة","كرسي","بطاطس","بسكوت","مكنسة","كيك","افوكادو","صابون","قمر","هرم","ساعةيد","كوكب","لابتوب","شنطة","عمارة","بيت","ديناصور","فرن","رز","مفتاح","رموش","جوارب","مدينة","قلم","سلة","حصان","زومبي","نجمة","علبة","مطبخ","فاصوليا","قهوة","كمبيوتر","ملوخية","قميص","مرحاض","فم","صقر","طاوله"]; // قائمة كلمات قابلة للتعديل
let savedBotWords = JSON.parse(localStorage.getItem("savedBotWords")) || [];

// 🏁 حالة اللعبة المحلية (تتم مزامنتها مع Firebase)
let localGameState = {
    inProgress: false,         // هل اللعبة جارية؟
    countdownActive: false,    // هل العد التنازلي نشط؟
    countdownInitiatorId: null,// معرف المستخدم الذي بدأ العد التنازلي
    gameWords: [],             // الكلمات الحالية للعبة
    gameStartTime: 0,          // وقت بدء اللعبة الفعلي (بعد العد التنازلي)
    lastGameId: null           // معرف فريد لكل جولة لعبة لمنع التكرار
};

// 🚩 متغير محلي لتتبع ما إذا كان هذا العميل قد بدأ العد التنازلي لجولة معينة
// هذا يضمن أن عميلًا واحدًا فقط يقوم بتشغيل العد التنازلي وإرسال الكلمات إلى Firebase
let initiatedCountdownGameId = null;

// 🔹 إنشاء معرف فريد للجهاز
let deviceId = localStorage.getItem("chat_device_id") || "dev_" + Math.floor(Math.random()*1e9);
localStorage.setItem("chat_device_id", deviceId);

// 🔹 اختيار اسم المستخدم
async function chooseUsername() {
  let username = localStorage.getItem("chat_username");
  const savedData = (await get(savedUsersRef)).val() || {};
  if(username && savedData[username]?.deviceId===deviceId) return username;

  let valid=false;
  while(!valid){
    username = prompt("اكتب اسمك:")?.trim();
    if(!username) continue;
    const usersData = (await get(usersRef)).val() || {};
    const nameTaken = Object.values(usersData).some(u=>u.name===username);
    const nameSavedElsewhere = savedData[username] && savedData[username].deviceId!==deviceId;
    if(nameTaken || nameSavedElsewhere) continue;
    valid=true;
  }
  localStorage.setItem("chat_username", username);
  return username;
}

const username = await chooseUsername();

// 🚫 التحقق من الحظر قبل إكمال الاتصال
async function checkBanStatus() {
    // هذه دالة وهمية للحصول على IP، في Cloud Function سيكون حقيقيًا
    // لأغراض الاختبار، سنستخدم قيمة عشوائية أو ثابتة
    const userIP = "192.168.1." + (Math.floor(Math.random() * 254) + 1); // IP وهمي للاختبار
    const ipHash = sha256(userIP); // استخدام sha256 من المكتبة المضافة

    const bannedSnapshot = await get(ref(db, `bannedIPs/${ipHash}`));
    if (bannedSnapshot.exists()) {
        document.body.innerHTML = `<div class="ban-message"><h1>🚫 أنت محظور</h1><p>تم حظرك من دخول هذه الدردشة.</p></div>`;
        // إيقاف أي عمليات أخرى
        throw new Error("User is banned");
    }
}

// 🔹 دالة رئيسية لتشغيل التطبيق
async function main() {
    // استدعاء دالة التحقق من الحظر
    try {
        await checkBanStatus();
    } catch (error) {
        console.error(error.message);
        return; // إيقاف تحميل باقي السكريبت إذا كان المستخدم محظورًا
    }

    // 🔹 تعريف متغيرات الحالة للمستخدمين والكتابة
    let currentUsers = {};
    let currentTyping = {};

    // 🔹 اختيار اللون وحفظه
    const colors = ["#ffadad","#ffd6a5","#fdffb6","#caffbf","#9bf6ff","#a0c4ff","#bdb2ff","#ffc6ff"];
    const userColor = colors[Math.floor(Math.random()*colors.length)];
    await set(ref(db, "savedUsers/"+username), {color:userColor, deviceId});

    // 🔹 إنشاء المستخدم
    const userId = "user_"+Math.floor(Math.random()*1e9); // معرف فريد للمستخدم الحالي
    const userRef = ref(db, "users/"+userId);
    function isMobileDevice() {
        return /Mobi|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    }
    const deviceType = isMobileDevice() ? 'mobile' : 'desktop';
    // سنضيف IP وهمي هنا ليتم استخدامه بواسطة Cloud Function
    // في البيئة الحقيقية، Cloud Function ستحصل على الـ IP الحقيقي من الطلب
    const fakeIP = "192.168.1." + (Math.floor(Math.random() * 254) + 1);
    await set(userRef, { name: username, color: userColor, online: true, lastSeen: Date.now(), device: deviceType, ip: fakeIP });

    // 🚫 مراقبة حالة الطرد
    onValue(ref(db, `kickedUsers/${userId}`), (snapshot) => {
        if (snapshot.exists() && snapshot.val() === true) {
            document.body.innerHTML = `<div class="ban-message"><h1>🚫 تم طردك</h1><p>لقد تم طردك من الغرفة بواسطة مشرف.</p></div>`;
            onDisconnect(userRef).cancel(); // إلغاء onDisconnect لمنع الحذف
        }
    });
    onDisconnect(userRef).remove();
    setInterval(()=>update(userRef,{online:true,lastSeen:Date.now()}),5000);

    // عناصر الصفحة
    const chatBox=document.getElementById("chat");
    const form=document.getElementById("chatForm");
    const msgInput=document.getElementById("msg");
    const typingBox=document.getElementById("typing");
    const userList=document.getElementById("users");

    // 🔹 صوت نقرة هادئة (مولد صوتي صغير عبر Web Audio)
    let audioEnabled = false;
    const AudioCtx = window.AudioContext || window.webkitAudioContext;
    const audioCtx = new (AudioCtx)();
    document.addEventListener('click', ()=>{
      audioEnabled = true;
      if(audioCtx.state === 'suspended') audioCtx.resume();
    }, {once: true});

    // مولد نقرة قصيرة هادئة (ضوضاء مشطوفة)
    function playClickNoise({volume = 0.05, duration = 0.018} = {}){
      if(!audioEnabled) return;
      try{
        const sampleCount = Math.max(64, Math.floor(audioCtx.sampleRate * duration));
        const buffer = audioCtx.createBuffer(1, sampleCount, audioCtx.sampleRate);
        const data = buffer.getChannelData(0);
        for(let i=0;i<sampleCount;i++){
          const env = Math.exp(-6 * (i / sampleCount));
          data[i] = (Math.random() * 2 - 1) * env * 0.7;
        }
        const src = audioCtx.createBufferSource();
        src.buffer = buffer;
        const g = audioCtx.createGain();
        g.gain.value = volume;
        src.connect(g);
        g.connect(audioCtx.destination);
        src.start();
        src.stop(audioCtx.currentTime + duration + 0.01);
      }catch(e){ /* silent failure */ }
    }

    // مولد نغمة قصيرة (لتمييز الخروج)
    function playBeep({freq = 700, volume = 0.04, duration = 0.06} = {}){
      if(!audioEnabled) return;
      try{
        const osc = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        osc.type = 'sine';
        osc.frequency.value = freq;
        g.gain.value = volume;
        // لفّ سريع للـ gain لإتقان النغمة
        g.gain.setValueAtTime(0.0001, audioCtx.currentTime);
        g.gain.exponentialRampToValueAtTime(volume, audioCtx.currentTime + 0.01);
        g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + duration);
        osc.connect(g);
        g.connect(audioCtx.destination);
        osc.start();
        osc.stop(audioCtx.currentTime + duration + 0.01);
      }catch(e){ /* silent failure */ }
    }

    // دوال مريحة للاستخدام في الانضمام/المغادرة
    const playJoin = ()=> playClickNoise({volume:1, duration:0.018});
    const playLeave = ()=> playBeep({freq:560, volume:1, duration:0.06});

    // 🔹 عرض المستخدمين مع حالة الكتابة
    function renderUsers(users, typingUsers){
      userList.innerHTML = "";
      const isAdmin = username === ADMIN_NAME;

      // إضافة البوت "بسام" إلى قائمة المتصلين بشكل دائم
      const botLi = document.createElement("li");
      botLi.innerHTML = `<img src="${BOT_AVATAR_URL}" class="user-list-avatar"> ${BOT_NAME}`;
      botLi.style.borderRight = `6px solid ${BOT_AVATAR_COLOR}`;
      botLi.style.fontWeight = "bold";
      userList.appendChild(botLi);


      // إضافة المستخدمين الحقيقيين
      Object.entries(users).forEach(([id,u])=>{
        const li = document.createElement("li");
        let typingAnim = "";
        if(typingUsers[id]){
          typingAnim = `<span class="dots">…</span>`;
        }
        const deviceEmoji = u.device === 'mobile' ? '📱' : '💻';
        
        let adminControls = '';
        // إذا كان المستخدم الحالي مشرفًا والمستخدم المعروض ليس هو المشرف نفسه
        if (isAdmin && u.name !== ADMIN_NAME) {
            adminControls = `
                <div class="admin-controls">
                    <button class="kick-btn" data-userid="${id}" data-username="${u.name}">طرد</button>
                    <button class="ban-btn" data-userid="${id}" data-username="${u.name}" data-ip="${u.ip || 'N/A'}">حظر IP</button>
                </div>
            `;
        }

        li.innerHTML = `
            <span>${deviceEmoji} ${u.name} ${typingAnim}</span>
            ${adminControls}
        `;
        li.style.borderRight = `6px solid ${u.color}`;
        userList.appendChild(li);
      });
    }

    // 🚫 استدعاء وظائف Cloud Functions
    const kickUserFn = httpsCallable(functions, 'kickUser');
    const banUserFn = httpsCallable(functions, 'banUser');
    const unbanIpFn = httpsCallable(functions, 'unbanIp');

    // 🚫 معالجة أحداث الضغط على أزرار التحكم
    userList.addEventListener('click', async (e) => {
        if (e.target.classList.contains('kick-btn')) {
            const targetUserId = e.target.dataset.userid;
            const targetUsername = e.target.dataset.username;
            if (confirm(`هل أنت متأكد من أنك تريد طرد ${targetUsername}؟`)) {
                try {
                    // إضافة callerUsername للتحقق من الصلاحيات في الخادم
                    const result = await kickUserFn({ targetUserId, targetUsername, callerUsername: username });
                    console.log(result.data.message);
                } catch (error) {
                    console.error("Error kicking user:", error);
                    alert(`فشل الطرد: ${error.message}`);
                }
            }
        }

        if (e.target.classList.contains('ban-btn')) {
            const targetUserId = e.target.dataset.userid;
            const targetUsername = e.target.dataset.username;
            const targetIp = e.target.dataset.ip;
            if (confirm(`هل أنت متأكد من أنك تريد حظر IP المستخدم ${targetUsername} (${targetIp}) وطرده؟`)) {
                try {
                    // إضافة callerUsername للتحقق من الصلاحيات في الخادم
                    const result = await banUserFn({ targetUserId, targetUsername, callerUsername: username });
                    console.log(result.data.message);
                } catch (error) {
                    console.error("Error banning user:", error);
                    alert(`فشل الحظر: ${error.message}`);
                }
            }
        }
    });

    // 🚫 عرض وإدارة لوحة الحظر للمشرف
    if (username === ADMIN_NAME) {
        const banManagementDiv = document.getElementById('ban-management');
        const bannedIpsList = document.getElementById('banned-ips-list');
        banManagementDiv.classList.add('visible');

        onValue(bannedIPsRef, (snapshot) => {
            bannedIpsList.innerHTML = '';
            const banned = snapshot.val() || {};
            if (Object.keys(banned).length === 0) {
                bannedIpsList.innerHTML = '<li>لا توجد عناوين IP محظورة حاليًا.</li>';
            }
            for (const [ipHash, data] of Object.entries(banned)) {
                const li = document.createElement('li');
                li.innerHTML = `
                    <span>
                        ${data.originalIpSnippet || 'N/A'} (محظور بواسطة: ${data.bannedBy} في ${new Date(data.timestamp).toLocaleString()})
                    </span>
                    <button class="unban-btn" data-iphash="${ipHash}">إلغاء الحظر</button>
                `;
                bannedIpsList.appendChild(li);
            }
        });

        bannedIpsList.addEventListener('click', async (e) => {
            if (e.target.classList.contains('unban-btn')) {
                const ipHash = e.target.dataset.iphash;
                if (confirm('هل أنت متأكد من إلغاء هذا الحظر؟')) {
                    try {
                        // إضافة callerUsername للتحقق من الصلاحيات في الخادم
                        const result = await unbanIpFn({ ipHash, callerUsername: username });
                        console.log(result.data.message);
                    } catch (error) {
                        console.error("Error unbanning IP:", error);
                        alert(`فشل إلغاء الحظر: ${error.message}`);
                    }
                }
            }
        });
    }

    // 🔹 استقبال المستخدمين
    onValue(usersRef, snapshot=>{
      currentUsers = snapshot.val() || {};
      renderUsers(currentUsers, currentTyping);
    });

    // 🔹 إشعار عند دخول وخروج المستخدمين
    onChildAdded(usersRef, snapshot=>{
      const u = snapshot.val();
      if(u.name !== username){
        const div = document.createElement("div");
        div.className="message";
        div.style.fontStyle="italic";
        div.style.color="#55ff55";
        div.textContent = `✅ ${u.name} انضم إلى الغرفة`;
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
        if(audioEnabled) playJoin();
      }
    });
    onChildRemoved(usersRef, snapshot=>{
      const u = snapshot.val();
      const div = document.createElement("div");
      div.className="message";
      div.style.fontStyle="italic";
      div.style.color="#ff5555";
      div.textContent = `❌ ${u.name} غادر الغرفة`;
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
      if(audioEnabled) playBeep({freq:1200, volume:0.5, duration:0.04}); // صوت استلام رسالة
      if(audioEnabled) playLeave();
    });

// 🤖 دالة لإرسال رسالة من البوت
function sendBotMessage(text) {
  push(messagesRef, {
    user: BOT_NAME,
    color: BOT_COLOR,
    userId: "bot_id", // معرف خاص بالبوت
    text: text,
    time: new Date().toLocaleTimeString(), // للعرض
    timestamp: Date.now() // للطوابع الزمنية الدقيقة (لعبة السرعة)
  });
}

// 🔹 استقبال الرسائل الجديدة فقط بعد دخول المستخدم
let firstLoad = true;
onChildAdded(messagesRef, snapshot=>{
  // إذا كان هذا هو التحميل الأولي للصفحة، لا تعرض الرسائل القديمة.
  if (firstLoad) return;

  const m = snapshot.val();
  const messageKey = snapshot.key; // مفتاح الرسالة الفريد

  // 🤖 الرد على التحية
  // يتم التحقق فقط إذا كانت الرسالة ليست من البوت، والنص هو "السلام عليكم"، ولم يتم الرد عليها بعد
  if (m.userId !== "bot_id" && m.text.trim() === "السلام عليكم" && !m.replied) {
    // فقط العميل الذي أرسل الرسالة الأصلية هو من يرد
    if (m.userId === userId) {
      // تأخير بسيط لجعل الرد يبدو طبيعيًا
      setTimeout(() => {
          sendBotMessage(`وعليكم السلام يا ${m.user} منوووووووووووووووووووووووووووووووووووور 🥳🎉👋`);
      }, 500);
    }
    // وضع علامة على الرسالة الأصلية بأنه تم الرد عليها لمنع التكرار
    update(ref(db, `messages/${messageKey}`), { replied: true });
  }

  // 🏁 التحقق من الفائز في لعبة سرعة الكتابة
  // يتم التحقق فقط إذا كانت اللعبة قيد التقدم، الرسالة ليست من البوت، النص يطابق كلمات اللعبة، ووقت الرسالة بعد بدء اللعبة.
  if (localGameState.inProgress && m.userId !== "bot_id" && m.text.trim() === localGameState.gameWords.join(" ") && m.timestamp > localGameState.gameStartTime) {
    // فقط العميل الذي أرسل رسالة الفوز هو من يعلن النتيجة وينهي اللعبة
    if (m.userId === userId) {
      const endTime = m.timestamp; // استخدام الطابع الزمني للرسالة الفائزة
      const timeDiffSeconds = (endTime - localGameState.gameStartTime) / 1000;
      const totalChars = localGameState.gameWords.join(" ").length;
      const wpm = Math.round((totalChars / 5) / (timeDiffSeconds / 60)); // حساب WPM

      // إعلان الفائز عبر البوت
      sendBotMessage(`🏆 الفائز هو ${m.user} بسرعة ${wpm} كلمة في الدقيقة!`);
      
      // إنهاء اللعبة في Firebase
      set(gameRef, {
          inProgress: false,
          countdownActive: false,
          countdownInitiatorId: null,
          gameWords: [],
          gameStartTime: 0,
          lastGameId: null // إعادة تعيين معرف اللعبة
      });
    }
  }

  // 🔽 عرض الرسائل الجديدة فقط في الشات
  // إنشاء الحاوية
  const msgContainer = document.createElement("div");
  msgContainer.classList.add("message");

  // إضافة اسم المستخدم والرسالة
  const textDiv = document.createElement("div");
  let nameColor = "white"; // الافتراضي: كل المستخدمين باللون الأبيض
  let isAdmin = false;

  // إذا كان المستخدم هو المسؤول، غيّر اللون إلى ذهبي
  if (m.user === ADMIN_NAME) {
    nameColor = "gold";
    isAdmin = true;
  }

  // 🤖 إذا كانت الرسالة من البوت، استخدم لونه المحدد
  if (m.user === BOT_NAME) {
    nameColor = BOT_COLOR;
  }

  // أضف التاج بجانب اسم المسؤول فقط 👑
  textDiv.innerHTML = `
    <strong class="username" style="color:${nameColor}">
      ${m.user}${isAdmin ? " 👑" : ""}:
    </strong> ${m.text}
  `;

  msgContainer.appendChild(textDiv);

  // إذا كانت الرسالة من المستخدم الحالي، أضف فئة خاصة لمحاذاتها يمينًا
  if (m.user === username) {
    msgContainer.classList.add("my-message");
  }

  // 🤖 إذا كانت الرسالة من البوت، أضف فئة خاصة
  if (m.user === BOT_NAME) {
    msgContainer.classList.add("bot-message");
  }

  // 🔹 إضافة صورة رمزية لمستخدم واحد محدد (مثلاً المدير)
  if (m.user === ADMIN_NAME) { // ← غيّر الاسم كما تريد
    const avatar = document.createElement("img");
    avatar.src = "https://i.pinimg.com/1200x/21/3d/f8/213df8f9bc8e0189d0b494a9b195e308.jpg"; // ضع رابط الصورة الرمزية هنا
    avatar.classList.add("avatar");
    msgContainer.appendChild(avatar);
  }

  // 🤖 إضافة صورة رمزية للبوت
  if (m.user === BOT_NAME) {
    const avatar = document.createElement("img");
    avatar.src = BOT_AVATAR_URL;
    avatar.classList.add("avatar");
    msgContainer.appendChild(avatar);
  }

  chatBox.appendChild(msgContainer);
  chatBox.scrollTop = chatBox.scrollHeight;
});

get(messagesRef).then(()=>{ firstLoad=false; });

// 🔹 تحديث فوري عند حذف الرسائل
onValue(messagesRef, snapshot => {
  if(!snapshot.exists()){
    chatBox.innerHTML = "";
  }
});

// 🏁 Listener لحالة اللعبة من Firebase
onValue(gameRef, async (snapshot) => {
    const firebaseState = snapshot.val() || {};

    // تحديث الحالة المحلية للعبة بناءً على Firebase
    localGameState = {
        inProgress: firebaseState.inProgress || false,
        countdownActive: firebaseState.countdownActive || false,
        countdownInitiatorId: firebaseState.countdownInitiatorId || null,
        gameWords: firebaseState.gameWords || [],
        gameStartTime: firebaseState.gameStartTime || 0,
        lastGameId: firebaseState.lastGameId || null
    };

    // منطق تشغيل العد التنازلي للعميل المحدد فقط
    if (localGameState.countdownActive && localGameState.countdownInitiatorId === userId) {
        // التحقق مما إذا كان هذا العميل قد بدأ العد التنازلي بالفعل لهذه الجولة
        if (initiatedCountdownGameId !== localGameState.lastGameId) {
            initiatedCountdownGameId = localGameState.lastGameId; // وضع علامة على هذه الجولة

            // تسلسل العد التنازلي
            await new Promise(resolve => setTimeout(resolve, 500));
            sendBotMessage("3...");
            await new Promise(resolve => setTimeout(resolve, 1000));
            sendBotMessage("2...");
            await new Promise(resolve => setTimeout(resolve, 1000));
            sendBotMessage("1...");
            await new Promise(resolve => setTimeout(resolve, 1000));

            // بعد العد التنازلي، أرسل الكلمات وحدث حالة اللعبة في Firebase
            sendBotMessage(` ${localGameState.gameWords.join(" ")}`);
            const newGameStartTime = Date.now();
            await set(gameRef, {
                ...localGameState, // الاحتفاظ بالخصائص الأخرى
                countdownActive: false, // انتهاء العد التنازلي
                inProgress: true,      // اللعبة الآن نشطة
                gameStartTime: newGameStartTime
            });
        }
    } else if (!localGameState.inProgress && !localGameState.countdownActive) {
        // إذا لم تكن اللعبة قيد التقدم ولا يوجد عد تنازلي، أعد تعيين علامة المبادرة
        initiatedCountdownGameId = null;
    }
});

// 🌪️ دالة لخلط ترتيب عناصر مصفوفة (خوارزمية Fisher-Yates)
function shuffleArray(array) {
    let currentIndex = array.length, randomIndex;
    // بينما لا يزال هناك عناصر لخلطها
    while (currentIndex !== 0) {
        // اختر عنصرًا متبقيًا
        randomIndex = Math.floor(Math.random() * currentIndex);
        currentIndex--;
        // وقم بتبديله مع العنصر الحالي
        [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
    }
    return array;
}

// 🔹 دالة مساعدة لإرسال الرسائل ومعالجة أوامر البوت
async function handleMessageSend(text) {
    if(!text) return;

    // أمر حذف الرسائل (للأدمن فقط)
    if(text.startsWith("/delete") && username === ADMIN_NAME){
        remove(messagesRef);
        return;
    }

    // 🤖 معالجة أوامر البوت "طش"
    if (text.startsWith("طش")) {
        const currentGameStateSnapshot = await get(gameRef); // الحصول على أحدث حالة للعبة من Firebase
        const currentGameState = currentGameStateSnapshot.val() || {};

        // إذا كانت اللعبة جارية بالفعل أو العد التنازلي نشط
        if (currentGameState.inProgress || currentGameState.countdownActive) {
            sendBotMessage("لعبة سرعة الكتابة جارية بالفعل. انتظر حتى تنتهي الجولة الحالية.");
            // لا نرسل رسالة المستخدم هنا لمنع التكرار، فقط نرسل رسالة البوت
            return; // إيقاف المزيد من المعالجة لهذا الأمر
        }

        // أمر "طش" مع رقم (مثال: طش7) - لحفظ الكلمات
        if (text.match(/^طش(\d+)$/)) {
            const numberMatch = text.match(/^طش(\d+)$/);
            const count = parseInt(numberMatch[1], 10);
            if (count > 0 && count <= BOT_WORDS_LIST.length) {
                savedBotWords = BOT_WORDS_LIST.slice(0, count);
                localStorage.setItem("savedBotWords", JSON.stringify(savedBotWords));
                sendBotMessage(`✅ تم حفظ ${count} كلمات للجولة القادمة.`);
            } else {
                sendBotMessage(`⚠️ يرجى تحديد عدد صحيح بين 1 و ${BOT_WORDS_LIST.length} لحفظ الكلمات.`);
            }
            return; // إيقاف المزيد من المعالجة
        }
        // أمر "طش" فقط - لبدء اللعبة
        else if (text === "طش") {
            if (savedBotWords.length > 0) {
                // 🌪️ خلط الكلمات واختيار مجموعة عشوائية جديدة لكل جولة
                const shuffledWords = shuffleArray([...BOT_WORDS_LIST]); // خلط نسخة من القائمة الكاملة
                const gameWordsForThisRound = shuffledWords.slice(0, savedBotWords.length); // أخذ العدد المطلوب من الكلمات

                // تحديث حالة اللعبة في Firebase لبدء العد التنازلي
                await set(gameRef, {
                    inProgress: false, // ليست قيد التقدم بعد، العد التنازلي نشط
                    countdownActive: true,
                    countdownInitiatorId: userId, // هذا المستخدم بدأ العد التنازلي
                    gameWords: gameWordsForThisRound, // استخدام الكلمات العشوائية لهذه الجولة
                    gameStartTime: 0, // سيتم تعيينه بعد العد التنازلي
                    lastGameId: new Date().getTime() // معرف فريد لجولة اللعبة هذه
                });
            } else {
                sendBotMessage("⚠️ لا توجد كلمات محفوظة. استخدم `طش` مع رقم أولاً (مثال: طش5).");
            }
            return; // إيقاف المزيد من المعالجة
        }
    }

    // 🔄 أمر "يلا" لإعادة تعيين الجولة
    if (text.trim() === "يلا") {
        const currentGameStateSnapshot = await get(gameRef);
        const currentGameState = currentGameStateSnapshot.val() || {};

        if (currentGameState.inProgress || currentGameState.countdownActive) {
            // إعادة تعيين حالة اللعبة في Firebase
            await set(gameRef, {
                inProgress: false, countdownActive: false, countdownInitiatorId: null,
                gameWords: [], gameStartTime: 0, lastGameId: null
            });
            sendBotMessage("🔄 تم إعادة تعيين الجولة. يمكنكم البدء من جديد بالأمر 'طش'.");
        }
        // لا نوقف المعالجة هنا، للسماح بإرسال رسالة "يلا" كرسالة عادية أدناه
    }

    // إرسال جميع الرسائل العادية (بما في ذلك أوامر البوت التي لم يتم إيقافها)
    // هذا يضمن أن userId يُرسل دائمًا
    push(messagesRef, {
        user: username,
        userId: userId, // التأكد من إرسال معرف المستخدم دائمًا
        color: userColor,
        text,
        time: new Date().toLocaleTimeString(),
        timestamp: Date.now()
    });
}

// 🔹 إرسال الرسائل بسرعة قصوى (تم تعديلها لاستخدام handleMessageSend)
form.addEventListener("submit", async e => {
  e.preventDefault();
  await handleMessageSend(msgInput.value.trim());
  msgInput.value = "";
  msgInput.focus(); // للحفاظ على التركيز بعد الإرسال
  remove(ref(db,"typing/"+userId));
  if(audioEnabled) playBeep({freq:900, volume:0.7, duration:0.045});
});

// إرسال فوري عند ضغط Enter (بدون Shift)
msgInput.addEventListener("keydown", async e => {
  if (e.key === "Enter" && !e.shiftKey) {
    e.preventDefault();
    await handleMessageSend(msgInput.value.trim());
    msgInput.value = "";
    msgInput.focus();
    remove(ref(db,"typing/"+userId));
    if(audioEnabled) playBeep({freq:900, volume:0.7, duration:0.045});
  }
});

// 🔹 الكتابة الحية مع نقاط متحركة
let typingTimeout;
msgInput.addEventListener("input", ()=>{
  set(ref(db,"typing/"+userId),{name:username, ts:Date.now()});
  clearTimeout(typingTimeout);
  typingTimeout = setTimeout(()=>remove(ref(db,"typing/"+userId)),2500);
});

onValue(typingRef,snapshot=>{
  const typingUsers = snapshot.val() || {};
  currentTyping = {};
  const now = Date.now();
  Object.entries(typingUsers).forEach(([id,u])=>{
    if(u.name !== username && now - (u.ts||0) < 2500){
      currentTyping[id] = true;
    }
  });
  renderUsers(currentUsers, currentTyping);

  // الرسالة أسفل الدردشة
  const names = Object.entries(typingUsers)
    .filter(([id,u])=>u.name!==username && now-(u.ts||0)<2500)
    .map(([id,u])=>u.name);
  typingBox.textContent = names.length ? `${names.join(" و ")} ${names.length>1?"يكتبون الآن...":"يكتب الآن..."}` : "";
});

} // نهاية الدالة main
main(); // استدعاء الدالة الرئيسية لبدء التطبيق
</script>

<style>
body {
  font-family: "Cairo", sans-serif;
  background: url("https://images.pexels.com/photos/33971618/pexels-photo-33971618.jpeg") no-repeat center center fixed;
  background-size: cover;
  color: #eee;
  margin: 0;
  padding: 0;
  text-align: center;
  display: flex;
  flex-direction: column;
  align-items: center;
  height: 100dvh;
}

/* 🔹 حاوية الشات */
.chat-container {
  width: 95%;
  max-width: 900px;
  margin-top: 20px;
}

/* 🔹 عنوان */
h2 { 
  color: #f2f2f2;
  margin: 0 0 10px 0;
  font-size: 1.3em;
  text-shadow: 0 2px 4px rgba(0,0,0,0.3);
  position: relative;
  padding-bottom: 8px;
}

h2::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 25%;
  width: 50%;
  height: 2px;
  background: linear-gradient(to right, transparent, #7c68ee00, transparent);
  border-radius: 2px;
}

/* 🔹 صندوق الشات */
#chat {
  width: 100%;
  height: 400px;
  overflow-y: auto;
  padding: 10px;
  background: #222a5900;;
  border-radius: 10px;
  box-sizing: border-box;
  scrollbar-width: thin;
  scrollbar-color: #333 #111;
}

#chat::-webkit-scrollbar { width: 6px; }
#chat::-webkit-scrollbar-thumb {
  background-color: #333;
  border-radius: 3px;
}

/* 🔹 الفقاعات */
.message {
  display: flex;
  align-items: center;
  justify-content: flex-start;
  direction: rtl;
  background-color: #090c1d69;
  border-radius: 10px;
  padding: 5px 10px;
  margin: 3px 0;
  gap: 6px;
  color: #f1f1f1;
  font-size: 0.95em;
  line-height: 1.3;
  max-width: 70%;
  word-break: break-word;
  animation: fadeIn 0.25s ease-out;
  box-shadow: 0 0 6px rgba(0,0,0,0.3);
}

/* 🤖 رسائل البوت */
.message.bot-message {
  background-color: #5c1118a8; /* خلفية مختلفة لرسائل البوت */
  border-left: 3px solid var(--bot-color, #ff4757);
  direction: ltr; /* لضمان ظهور الأيقونة يسارًا إذا أضيفت */
  justify-content: flex-start;
}

/* 🔹 اسم المستخدم */
.message strong {
  display: inline;
  color: #8ef2a2;
  font-weight: bold;
  font-size: 0.9em;
  margin-left: 3px;
}

/* 🔹 رسائل المستخدم */
.message.my-message {
  margin-left: auto;
  background-color: #667e174d;
  text-align: right;
  flex-direction: row-reverse;
}

/* 🔹 الصورة الشخصية */
.avatar {
  width: 26px;
  height: 26px;
  border-radius: 50%;
  border: 1.5px solid #3cdf28;
  flex-shrink: 0;
}

/* 🔹 شريط الإدخال */
form {
  width: 100%;
  display: flex;
  margin-top: 8px;
  padding: 6px;
  background: rgba(27, 30, 48, 0.8);
  border-radius: 8px;
}

input {
  flex: 1;
  padding: 8px;
  border-radius: 6px;
  border: none;
  font-size: 0.95em;
  background-color: #11143100;
  color: #f9f9f9;
  outline: none;
}

button {
  padding: 8px 16px;
  border: none;
  border-radius: 6px;
  background: #7c68ee00;
  color: #ffee04;
  font-weight: bold;
  cursor: pointer;
  transition: 0.2s;
}

button:hover {
  background: #6956d600;
}

/* 🔹 قائمة المستخدمين */
#users {
  list-style: none;
  padding: 0;
  margin: 10px 0 5px 0;
  width: 95%;
  max-width: 900px;
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  justify-content: center;
}

#users li {
  background: #47474721;
  padding: 6px 12px;
  border-radius: 15px;
  font-size: 0.9em;
  transition: 0.15s;
}

/* 🔹 صورة الأفاتار في قائمة المتصلين */
.user-list-avatar {
  width: 20px;
  height: 20px;
  border-radius: 50%;
  margin-left: 5px; /* مسافة بين الصورة والاسم */
}

#users li:hover {
  transform: translateY(-2px);
  background: #222;
}

/* 🔹 تأثير الظهور */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

/* 🚫 رسالة الحظر */
.ban-message { text-align: center; padding-top: 20vh; color: #ff5555; }
.ban-message h1 { font-size: 2.5em; }

/* 🔹 للهاتف */
@media screen and (max-width: 768px) {
  #chat {
    height: 250px;
    padding: 6px;
  }

  .message {
    font-size: 0.85em;
    padding: 4px 6px;
    border-radius: 8px;
    max-width: 80%;
  }

  .avatar {
    width: 22px;
    height: 22px;
  }

  input {
    font-size: 0.85em;
    padding: 6px;
  }

  button {
    padding: 7px 12px;
    font-size: 0.85em;
  }
}

/* 🚫 أزرار التحكم للمشرف */
.admin-controls {
  margin-right: auto; /* يدفع الأزرار إلى اليسار في LTR، وإلى اليمين في RTL */
  display: flex;
  gap: 5px;
}
.admin-controls button {
  padding: 2px 8px;
  font-size: 0.75em;
  border-radius: 4px;
  cursor: pointer;
  border: none;
  color: white;
}
.kick-btn { background-color: #e67e22; }
.ban-btn { background-color: #c0392b; }
.kick-btn:hover { background-color: #d35400; }
.ban-btn:hover { background-color: #a52a1d; }

/* 🚫 لوحة إدارة الحظر */
#ban-management { display: none; /* تظهر فقط للمشرف */ }
#ban-management.visible { display: block; margin-top: 20px; padding: 15px; background: #1a1a1a; border-radius: 8px; }
#banned-ips-list li { display: flex; justify-content: space-between; align-items: center; padding: 5px; border-bottom: 1px solid #333; }
.unban-btn { background-color: #27ae60; padding: 3px 8px; font-size: 0.8em; }

#users li {
    display: flex; /* لتمكين محاذاة الأزرار */
    align-items: center;
}
</style>





</head>
<body>
<h5 style="margin-top:20px; margin-bottom:10px;">المتصلون الآن:</h5>
<ul id="users"></ul>
<!-- تم وضع عناصر الشات داخل حاوية جديدة لتنظيمها -->
<div class="chat-container">
  <h2>💬chat</h2>
  <div id="chat"></div>
  <div id="typing"></div>
  <form id="chatForm">
    <input id="msg" placeholder=" " autocomplete="off" />
    <button>إرسال</button>
  </form>

  <!-- 🚫 لوحة إدارة الحظر (للمشرف فقط) -->
  <div id="ban-management">
      <h3>إدارة الحظر</h3>
      <ul id="banned-ips-list"></ul>
  </div>

</div>
</body>
</html>
